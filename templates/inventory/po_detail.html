{% extends 'base.html' %} {% load humanize %} {% block title %}PO #{{
po.po_number }} - ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î{% endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12 d-flex justify-content-between align-items-center">
    <div>
      <h2 class="mb-0">
        üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Detail) #<span class="text-info"
          >{{ po.po_number }}</span
        >
      </h2>
      <span
        class="badge {% if po.status == 'Pending' %}bg-warning text-dark{% else %}bg-success{% endif %} mt-2 fs-6"
      >
        {{ po.status }}
      </span>
    </div>
    <div>
      <a href="{% url 'po_list' %}" class="btn btn-outline-light">
        <i class="bi bi-arrow-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
      </a>
    </div>
  </div>
</div>

<!-- Header Info Form -->
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <input type="hidden" name="action" value="update_header" />

  <div class="card mb-4 shadow-sm border-secondary">
    <div
      class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center"
    >
      <h5 class="mb-0 text-white">
        <i class="bi bi-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Header Info)
      </h5>
      <!-- Always show Save Button per user request -->
      <button type="submit" class="btn btn-sm btn-primary">
        <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Save Header)
      </button>
    </div>
    <div class="card-body bg-dark text-white">
      <!-- Row 1: Basic Info -->
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <label class="form-label text-muted small"
            >‡πÄ‡∏•‡∏Ç PO (PO Number) <span class="text-danger">*</span></label
          >
          <input
            type="text"
            name="po_number"
            class="form-control bg-dark text-white border-secondary"
            value="{{ po.po_number }}"
            required
            {% if po.status != "Pending" %}readonly{% endif %}
          />
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small"
            >‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Order Date)</label
          >
          <input
            type="date"
            name="order_date"
            class="form-control bg-dark text-white border-secondary"
            value="{{ po.order_date|date:'Y-m-d' }}"
            {% if po.status != "Pending" %}readonly{% endif %}
          />
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Order Type)</label>
          <select
            name="order_type"
            class="form-select bg-dark text-white border-secondary"
            {% if po.status != "Pending" %}disabled{% endif %}
          >
            <option
              value="IMPORTED"
              {% if po.order_type == "IMPORTED" %}selected{% endif %}
            >
              Imported (‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤)
            </option>
            <option
              value="DOMESTIC"
              {% if po.order_type == "DOMESTIC" %}selected{% endif %}
            >
              Domestic (‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)
            </option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small">‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á (Shipping)</label>
          <select
            name="shipping_type"
            class="form-select bg-dark text-white border-secondary"
            {%
            if
            po.status
            !="Pending"
            %}disabled{%
            endif
            %}
          >
            <option value="CAR" {% if po.shipping_type == "CAR" %}selected{% endif %}>Car (‡∏£‡∏ñ)</option>
            <option value="SHIP" {% if po.shipping_type == "SHIP" %}selected{% endif %}>Ship (‡πÄ‡∏£‡∏∑‡∏≠)</option>
            <option value="AIR" {% if po.shipping_type == "AIR" %}selected{% endif %}>Air (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô)</option>
          </select>
        </div>
      </div>

      <!-- Row 2: Metrics -->
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <label class="form-label text-muted small"
            >‡∏ß‡∏±‡∏ô‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (Est. Date)</label
          >
          <input
            type="date"
            name="estimated_date"
            class="form-control bg-dark text-white border-secondary"
            value="{{ po.estimated_date|date:'Y-m-d'|default:'' }}"
            {%
            if
            po.status
            !="Pending"
            %}readonly{%
            endif
            %}
          />
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small"
            >‡πÄ‡∏£‡∏ó‡πÄ‡∏á‡∏¥‡∏ô (Exchange Rate)</label
          >
          <input
            type="number"
            step="0.01"
            name="exchange_rate"
            id="input_exchange_rate"
            class="form-control bg-dark text-white border-secondary"
            value="{{ po.exchange_rate }}"
            oninput="calcTransportCost()"
            {% if po.status != "Pending" %} {% endif %}
          />
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small"
            >‡πÄ‡∏£‡∏ó‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á (¬•/CBM)</label
          >
          <input
            type="number"
            step="0.01"
            name="shipping_rate_yuan_per_cbm"
            id="input_rate_yuan"
            class="form-control bg-dark text-white border-secondary"
            value="{{ po.shipping_rate_yuan_per_cbm }}"
            oninput="calcTransportCost()"
          />
        </div>
        <div class="col-md-3">
            <label class="form-label text-muted small">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á (‡∏ø)</label>
            <div class="input-group">
                 <input type="text" id="input_transport_cost" class="form-control bg-dark text-white border-secondary" readonly value="{{ po.transportation_cost|floatformat:2 }} ‡∏ø">
                 <span class="input-group-text bg-secondary text-white border-secondary small" style="font-size: 0.7em;" id="cbm_display" data-cbm="{{ po.total_cbm }}">
                    (CBM: {{ po.total_cbm|floatformat:2 }})
                 </span>
            </div>
        </div>
      </div>
        </div>
        

      <hr class="border-secondary opacity-50" />
      <h6 class="text-white mb-3 small opacity-75 px-3">
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ (Supplier / Pricing Ref)
      </h6>

      <!-- Row 3: Shop & Attachments -->
      <div class="row g-3 mb-3 px-3">
        <div class="col-md-4">
          <label class="form-label text-muted small">Link Shop</label>
          <input
            type="url"
            name="link_shop"
            class="form-control bg-dark text-white border-secondary"
            placeholder="URL ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏µ‡∏ô..."
            value="{{ po.link_shop }}"
            {%
            if
            po.status
            !="Pending"
            %}readonly{%
            endif
            %}
          />
        </div>
        <div class="col-md-4">
          <label class="form-label text-muted small">WeChat / Contact</label>
          <input
            type="text"
            name="wechat_contact"
            class="form-control bg-dark text-white border-secondary"
            value="{{ po.wechat_contact }}"
            {% if po.status != "Pending" %}readonly{% endif %}
          />
        </div>
        <div class="col-md-4">
          <label class="form-label text-muted small"
            >‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (Attach Files)</label
          >
          <input
            type="file"
            name="attachments"
            multiple
            class="form-control bg-dark text-white border-secondary"
            {% if po.status != "Pending" %}disabled{% endif %}
          />
          <!-- Display Existing Attachments -->
          {% if po.attachments.exists %}
          <div class="mt-2">
            <small class="text-muted">‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡πÅ‡∏•‡πâ‡∏ß:</small>
            <div class="d-flex flex-wrap gap-2 mt-1">
              {% for file in po.attachments.all %}
              <a
                href="{{ file.file.url }}"
                target="_blank"
                class="badge bg-secondary text-decoration-none"
              >
                <i class="bi bi-paperclip"></i> 
			{{ file.filename|truncatechars:15 }}
              </a>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Row 4: Pricing Refs & Note -->
      <div class="row g-3 px-3 pb-3">
        <div class="col-md-3">
          <label class="form-label text-muted small">‡∏£‡∏≤‡∏Ñ‡∏≤ Shopee (Ref)</label>
          <input
            type="number"
            step="0.01"
            name="shopee_price"
            class="form-control bg-dark text-white border-secondary"
            value="{{ po.shopee_price|default:'' }}"
            {% if po.status != "Pending" %}readonly{% endif %}
          />
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small">‡∏£‡∏≤‡∏Ñ‡∏≤ Lazada (Ref)</label>
          <input
            type="number"
            step="0.01"
            name="lazada_price"
            class="form-control bg-dark text-white border-secondary"
            value="{{ po.lazada_price|default:'' }}"
            {% if po.status != "Pending" %}readonly{% endif %}
          />
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small">‡∏£‡∏≤‡∏Ñ‡∏≤ TikTok (Ref)</label>
          <input
            type="number"
            step="0.01"
            name="tiktok_price"
            class="form-control bg-dark text-white border-secondary"
            value="{{ po.tiktok_price|default:'' }}"
            {% if po.status != "Pending" %}readonly{% endif %}
          />
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Note)</label>
          <input
            type="text"
            name="note"
            class="form-control bg-dark text-white border-secondary"
            value="{{ po.note }}"
            {% if po.status != "Pending" %}readonly{% endif %}
          />
        </div>
      </div>
    </div>
  </div>
</form>

<!-- Items Table Form -->
<form method="post" id="itemsForm">
  {% csrf_token %}
  <input type="hidden" name="action" value="receive_items" />

  <div class="card shadow-sm border-secondary">
    <div
      class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center"
    >
      <h5 class="mb-0 text-white">
        <i class="bi bi-list-check"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Items)
      </h5>

      <!-- Allow receiving always, logic handles completion -->
      <div
        class="d-flex flex-wrap align-items-end justify-content-between gap-3"
      >
        <!-- Date & Receive Action -->
        <div class="d-flex gap-2 align-items-center">
          <div class="input-group input-group-sm" style="width: auto">
            <span
              class="input-group-text bg-secondary text-white border-secondary"
            >
              <i class="bi bi-calendar3 me-1"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö
            </span>
            <input
              type="date"
              name="receive_date"
              class="form-control bg-dark text-white border-secondary"
              value="{% now 'Y-m-d' %}"
            />
          </div>

          <button
            type="submit"
            name="action"
            value="update_items"
            class="btn btn-sm btn-primary fw-bold text-nowrap px-3 shadow-sm"
          >
            <i class="bi bi-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          </button>
        </div>

        <!-- Add Item Button -->
        <button
          type="button"
          class="btn btn-sm btn-outline-warning text-nowrap"
          data-bs-toggle="modal"
          data-bs-target="#addItemModal"
        >
          <i class="bi bi-plus-lg me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </button>

        <!-- History Button -->
        <button
          type="button"
          class="btn btn-sm btn-outline-info text-nowrap"
          data-bs-toggle="modal"
          data-bs-target="#historyModal"
        >
          <i class="bi bi-clock-history me-1"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
        </button>
      </div>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-dark table-hover align-middle mb-0">
          <thead>
            <tr class="text-center align-middle">
              <th rowspan="2" style="width: 40px">
                <input type="checkbox" id="selectAll" />
              </th>
              <th rowspan="2" style="width: 60px">‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th rowspan="2">SKU / Name</th>
              <th rowspan="2" class="text-end">‡∏£‡∏≤‡∏Ñ‡∏≤ (¬•)</th>
              <th rowspan="2" class="text-end">‡∏£‡∏ß‡∏° (‡∏ø)</th>

              <!-- Ordered Group -->
              <th
                colspan="3"
                class="bg-success text-white border-bottom border-light"
              >
                Ordered (‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠)
              </th>
              <!-- Received Group -->
              <th
                colspan="3"
                class="bg-info text-dark border-bottom border-light"
              >
                Received (‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß)
              </th>
              <!-- Input Group -->
              <th
                colspan="3"
                class="bg-dark text-white border-bottom border-light"
              >
                Receive Now (‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ)
              </th>
              <th rowspan="2" style="width: 50px"></th>
            </tr>
            <tr class="text-center small">
              <!-- Ordered Subcols -->
              <th class="bg-success text-white" style="width: 90px">Qty</th>
              <th class="bg-success text-white" style="width: 90px">‡∏Ñ‡∏¥‡∏ß</th>
              <th class="bg-success text-white" style="width: 90px">Kg</th>

              <!-- Received Subcols -->
              <th class="bg-info text-dark" style="width: 90px">Qty</th>
              <th class="bg-info text-dark" style="width: 90px">‡∏Ñ‡∏¥‡∏ß</th>
              <th class="bg-info text-dark" style="width: 90px">Kg</th>

              <!-- Input Subcols -->
              <th class="bg-dark text-white" style="width: 90px">Qty</th>
              <th class="bg-dark text-white" style="width: 90px">‡∏Ñ‡∏¥‡∏ß</th>
              <th class="bg-dark text-white" style="width: 90px">Kg</th>
            </tr>
          </thead>
          <tbody>
            {% for item in po.items.all %}
            <tr>
              <td>
                {% if item.qty_ordered > item.total_received_qty %}
                <input
                  type="checkbox"
                  class="item-check"
                  id="chk_{{ item.id }}"
                  data-remaining="{{ item.remaining_qty }}"
                  onchange="onCheckboxChange('{{ item.id }}')"
                />
                {% endif %}
              </td>
              <td>
                {% if item.sku.image %}
                <img
                  src="{{ item.sku.image.url }}"
                  style="height: 60px"
                  class="rounded"
                />
                {% endif %}
              </td>
              <td class="text-center">
                <div class="fw-bold">{{ item.sku.product_code }}</div>
                <div class="small text-muted">
                  {{ item.sku.name|truncatechars:30 }}
                </div>
              </td>
              <td class="text-end">{{ item.price_yuan }}</td>
              <td class="text-end">{{ item.price_baht|intcomma }}</td>

              <!-- Ordered Data -->
              <!-- Ordered Data (Editable) -->
              <!-- Ordered Data (Editable) -->
              <td class="p-1 bg-success bg-opacity-25">
                <input type="number" name="qty_ordered_{{ item.id }}" class="form-control form-control-sm bg-dark text-white border-secondary text-center" value="{{ item.qty_ordered }}" min="0">
              </td>
              <td class="p-1 bg-success bg-opacity-25">
                 <input type="number" step="0.0001" name="cbm_{{ item.id }}" class="form-control form-control-sm bg-dark text-white border-secondary text-center item-cbm-input" value="{{ item.cbm|default_if_none:0 }}" oninput="recalcTotalCBM()">
              </td>
              <td class="p-1 bg-success bg-opacity-25">
                <input type="number" step="0.01" name="weight_{{ item.id }}" class="form-control form-control-sm bg-dark text-white border-secondary text-center" value="{{ item.weight|default_if_none:0 }}">
              </td>

              <!-- Received Data -->
              <td class="text-center bg-info bg-opacity-25 fw-bold">
                {{ item.total_received_qty|intcomma }}
              </td>
              <td class="text-center bg-info bg-opacity-25">
                {{ item.total_received_cbm|floatformat:2|default_if_none:"-" }}
              </td>
              <td class="text-center bg-info bg-opacity-25">
                {{ item.total_received_weight|floatformat:2|default_if_none:"-" }}
              </td>

              <!-- Input Data: Disable Enter Key -->
              <td class="bg-secondary bg-opacity-25" style="width: 90px">
                {% if item.qty_ordered > item.total_received_qty %}
                <input
                  type="number"
                  name="receive_qty_{{ item.id }}"
                  id="qty_{{ item.id }}"
                  class="form-control form-control-sm bg-dark text-white border-secondary text-center"
                  data-remaining="{{ item.remaining_qty }}"
                  oninput="onInputChange('{{ item.id }}')"
                  onkeydown="return event.key != 'Enter';"
                  placeholder="0"
                />
                {% else %}
                <span class="badge bg-success w-100">Complete</span>
                {% endif %}
              </td>
              <td class="bg-secondary bg-opacity-25">
                <input
                  type="number"
                  step="0.0001"
                  name="receive_cbm_{{ item.id }}"
                  class="form-control form-control-sm bg-dark text-white border-secondary text-center"
                  onkeydown="return event.key != 'Enter';"
                  placeholder="0"
                />
              </td>
              <td class="bg-secondary bg-opacity-25">
                <input
                  type="number"
                  step="0.01"
                  name="receive_weight_{{ item.id }}"
                  class="form-control form-control-sm bg-dark text-white border-secondary text-center"
                  onkeydown="return event.key != 'Enter';"
                  placeholder="0"
                />
              </td>
              <td class="text-center">
                  <button type="submit" name="action" value="delete_item_{{ item.id }}" class="btn btn-sm btn-link text-danger p-0" onclick="return confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?');" title="Delete">
                      <i class="bi bi-x-lg"></i>
                  </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</form>

<script>
  // When checkbox changes
  function calcTransportCost() {
      const exRate = parseFloat(document.getElementById('input_exchange_rate').value) || 0;
      const yuanRate = parseFloat(document.getElementById('input_rate_yuan').value) || 0;
      const totalCbm = parseFloat(document.getElementById('cbm_display').getAttribute('data-cbm')) || 0;
      
      const totalBaht = totalCbm * yuanRate * exRate;
      document.getElementById('input_transport_cost').value = totalBaht.toFixed(2) + " ‡∏ø";
  }

  function onCheckboxChange(itemId) {
    const checkbox = document.getElementById("chk_" + itemId);
    const input = document.getElementById("qty_" + itemId);

    if (checkbox.checked) {
      if (!input.value) {
        input.value = input.getAttribute("data-remaining");
      }
      input.focus();
    } else {
      input.value = "";
    }
  }

  // When input changes
  function onInputChange(itemId) {
    const checkbox = document.getElementById("chk_" + itemId);
    const input = document.getElementById("qty_" + itemId);
    const val = parseFloat(input.value);

    if (val > 0) {
      checkbox.checked = true;
    } else {
      checkbox.checked = false;
    }
  }

  // Select All
  document.getElementById("selectAll").addEventListener("change", function () {
    const checkboxes = document.querySelectorAll(".item-check");
    checkboxes.forEach((cb) => {
      const itemId = cb.getAttribute("id").split("_")[1];
      cb.checked = this.checked;
      onCheckboxChange(itemId);
    });
  });
</script>

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">
          <i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Receiving
          History)
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-dark table-sm table-hover">
            <thead>
              <tr>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th>
                <th>SKU</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="text-end">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Qty)</th>
                <th class="text-end">‡∏Ñ‡∏¥‡∏ß</th>
                <th class="text-end">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (KG)</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody>
              {% for item in po.items.all %} 
		{% for receipt in item.receipts.all %}
              <tr>
                <td>{{ receipt.received_date|date:"d/m/Y" }}</td>
                <td class="fw-bold">{{ item.sku.product_code }}</td>
                <td>{{ item.sku.name|truncatechars:40 }}</td>
                <td class="text-end">{{ receipt.received_qty }}</td>
                <td class="text-end">
                  {{ receipt.received_cbm|floatformat:2 }}
                </td>
                <td class="text-end">
                  {{ receipt.received_weight|floatformat:2 }}
                </td>
                <td class="text-center">
                    <form action="{% url 'delete_received_item' receipt.id %}" method="post" onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger px-2 py-0"><i class="bi bi-trash"></i></button>
                    </form>
                </td>
              </tr>
              {% endfor %} 
		{% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          ‡∏õ‡∏¥‡∏î
        </button>
      </div>
    </div>
  </div>
</div>



<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white border-secondary">
        <form method="POST">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_item">
          
          <div class="modal-header border-secondary">
            <h5 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Add Item)</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
              <div class="mb-3">
                  <label class="form-label">Search SKU / Name</label>
                  <input type="text" name="sku_code" class="form-control bg-dark text-white border-secondary" placeholder="Enter SKU" required list="skuOptions">
                  <datalist id="skuOptions">
                      {% for m in master_items %}
                      <option value="{{ m.product_code }}">{{ m.name }}</option>
                      {% endfor %}
                  </datalist>
              </div>
              <div class="row">
                  <div class="col-4">
                      <label class="form-label">Qty</label>
                      <input type="number" name="new_qty" class="form-control bg-dark text-white border-secondary" value="1" min="1" required>
                  </div>
                  <div class="col-4">
                      <label class="form-label">CBM</label>
                      <input type="number" step="0.0001" name="new_cbm" class="form-control bg-dark text-white border-secondary" value="0">
                  </div>
                  <div class="col-4">
                      <label class="form-label">Weight</label>
                      <input type="number" step="0.01" name="new_weight" class="form-control bg-dark text-white border-secondary" value="0">
                  </div>
              </div>
               <div class="row mt-2">
                  <div class="col-6">
                      <label class="form-label">Price (Yuan)</label>
                      <input type="number" step="0.01" name="new_price_yuan" class="form-control bg-dark text-white border-secondary" value="0">
                  </div>
              </div>
          </div>
          <div class="modal-footer border-secondary">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Add Item</button>
          </div>
        </form>
    </div>
  </div>
</div>

<script>
  // Recalculate total CBM from inputs
  function recalcTotalCBM() {
      let total = 0;
      document.querySelectorAll('.item-cbm-input').forEach(input => {
          total += parseFloat(input.value) || 0;
      });
      
      // Update Display and Data Attribute
      const display = document.getElementById('cbm_display');
      if(display) {
          display.setAttribute('data-cbm', total);
          display.innerText = `(CBM: ${total.toFixed(2)})`;
      }
      
      // Trigger cost recalc
      if (typeof calcTransportCost === "function") {
          calcTransportCost();
      }
  }
</script>
{% endblock %}
