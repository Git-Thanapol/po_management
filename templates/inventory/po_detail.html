{% extends 'base.html' %} {% load humanize %} {% block title %}PO #{{
po.po_number }} - ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î{% endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12 d-flex justify-content-between align-items-center">
    <div>
      <h2 class="mb-0">
        üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Detail) #<span class="text-info">{{ po.po_number }}</span>
      </h2>
      <span class="badge {% if po.status == 'Pending' %}bg-warning text-dark{% else %}bg-success{% endif %} mt-2 fs-6">
        {{ po.status }}
      </span>
    </div>
    <div>
      <a href="{% url 'po_list' %}" class="btn btn-outline-light">
        <i class="bi bi-arrow-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
      </a>
    </div>
  </div>
</div>

<!-- Header Info Form -->
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <input type="hidden" name="action" value="update_header" />

  <div class="card mb-4 shadow-sm border-secondary">
    <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center">
      <h5 class="mb-0 text-white">
        <i class="bi bi-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Header Info)
      </h5>
      <!-- Always show Save Button per user request -->
      <button type="submit" class="btn btn-sm btn-primary">
        <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Save Header)
      </button>
    </div>
    <div class="card-body bg-dark text-white">
      <!-- Row 1: Basic Info -->
      <div class="row g-3 mb-3">
        <div class="col-md-2">
          <label class="form-label text-muted small">‡πÄ‡∏•‡∏Ç PO (PO Number) <span class="text-danger">*</span></label>
          <input type="text" name="po_number" class="form-control bg-dark text-white border-secondary"
            value="{{ po.po_number }}" required {% if po.status != "Pending" %}readonly{% endif %} />
        </div>
        <div class="col-md-2">
          <label class="form-label text-muted small">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Order Date)</label>
          <input type="date" name="order_date" class="form-control bg-dark text-white border-secondary"
            value="{{ po.order_date|date:'Y-m-d' }}" {% if po.status != "Pending" %}readonly{% endif %} />
        </div>
        <div class="col-md-2">
          <label class="form-label text-muted small">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Order Type)</label>
          <select name="order_type" class="form-select bg-dark text-white border-secondary" 
            {% if po.status != "Pending" %} disabled {% endif %}>
            <option value="IMPORTED" {% if po.order_type == "IMPORTED" %}selected{% endif %}>
              Imported (‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤)
            </option>
            <option value="DOMESTIC" {% if po.order_type == "DOMESTIC" %}selected{% endif %}>
              Domestic (‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)
            </option>
          </select>
        </div>
      
      {% if po.order_type == 'IMPORTED' %}
      <div class="col-md-2">
        <label class="form-label text-muted small">‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á (Shipping)</label>
        <select name="shipping_type" class="form-select bg-dark text-white border-secondary" 
          {% if po.status != "Pending" %} disabled {% endif %}>
          <option value="CAR" {% if po.shipping_type == "CAR" %}selected{% endif %}>Car (‡∏£‡∏ñ)</option>
          <option value="SHIP" {% if po.shipping_type == "SHIP" %}selected{% endif %}>Ship (‡πÄ‡∏£‡∏∑‡∏≠)</option>
          <option value="AIR" {% if po.shipping_type == "AIR" %}selected{% endif %}>Air (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô)</option>
        </select>
      </div>
      {% endif %}
      <div class="col-md-2">
        <label class="form-label text-muted small">
          {% if po.order_type == 'DOMESTIC' %}‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Received Date){% else %}‡∏ß‡∏±‡∏ô‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå
          {% endif %}
        </label>
        <input type="date" name="estimated_date" class="form-control bg-dark text-white border-secondary"
          value="{{ po.estimated_date|date:'Y-m-d'|default:'' }}" />
      </div>
      <div class="col-md-2">
        <label class="form-label text-muted small">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏• (Bill Date)</label>
        <input type="date" name="bill_date" class="form-control bg-dark text-white border-secondary"
          value="{{ po.bill_date|date:'Y-m-d'|default:'' }}" />
      </div>
    </div>

    <hr class="border-secondary opacity-50" />

    <!-- Row 2: Supplier -->
    <h6 class="text-white mb-3 small opacity-75">
      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ (Supplier / Pricing Ref)
    </h6>
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="form-label text-muted small">Link Shop</label>
        <input type="url" name="link_shop" class="form-control bg-dark text-white border-secondary"
          placeholder="URL ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏µ‡∏ô..." value="{{ po.link_shop }}" />
      </div>
      <div class="col-md-4">
        <label class="form-label text-muted small">WeChat / Contact</label>
        <input type="text" name="wechat_contact" class="form-control bg-dark text-white border-secondary"
          value="{{ po.wechat_contact }}" />
      </div>
      <div class="col-md-4">
        <label class="form-label text-muted small">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (Attach Files)</label>
        <input type="file" name="attachments" multiple class="form-control bg-dark text-white border-secondary" />
        <!-- Display Existing Attachments -->
        {% if po.attachments.exists %}
        <div class="mt-2">
          <small class="text-muted">‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡πÅ‡∏•‡πâ‡∏ß:</small>
          <div class="d-flex flex-wrap gap-2 mt-1">
            {% for file in po.attachments.all %}
            <a href="{{ file.file.url }}" target="_blank" class="badge bg-secondary text-decoration-none">
              <i class="bi bi-paperclip"></i>
              {{ file.filename|truncatechars:15 }}
            </a>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Reference Prices -->
    <div class="row g-3  pb-3">
      <div class="col-md-3">
        <label class="form-label text-muted small">‡∏£‡∏≤‡∏Ñ‡∏≤ Shopee (Ref)</label>
        <input type="number" step="0.01" name="shopee_price" class="form-control bg-dark text-white border-secondary"
          value="{{ po.ref_price_shopee|default:'' }}" />
      </div>
      <div class="col-md-3">
        <label class="form-label text-muted small">‡∏£‡∏≤‡∏Ñ‡∏≤ Lazada (Ref)</label>
        <input type="number" step="0.01" name="lazada_price" class="form-control bg-dark text-white border-secondary"
          value="{{ po.ref_price_lazada|default:'' }}" />
      </div>
      <div class="col-md-3">
        <label class="form-label text-muted small">‡∏£‡∏≤‡∏Ñ‡∏≤ TikTok (Ref)</label>
        <input type="number" step="0.01" name="tiktok_price" class="form-control bg-dark text-white border-secondary"
          value="{{ po.ref_price_tiktok|default:'' }}" />
      </div>

      <div class="col-md-3">
        <label class="form-label text-muted small">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Note)</label>
        <input type="text" name="note" class="form-control bg-dark text-white border-secondary" value="{{ po.note }}" />
      </div>
    </div>

    
    <hr class="border-secondary opacity-50" />

    <!-- Row 3: Financial -->
    <h6 class="text-white mb-3 small opacity-75">
      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (Financial)
    </h6>
    {% if po.order_type == 'IMPORTED' %}
    <div class="row g-3 mb-3">
      <div class="col-md-2">
        <label class="form-label text-muted small">‡πÄ‡∏£‡∏ó‡πÄ‡∏á‡∏¥‡∏ô (Exchange Rate)</label>
        <input type="number" step="0.0001" name="exchange_rate" id="input_exchange_rate"
          class="form-control bg-dark text-white border-secondary" value="{{ po.exchange_rate }}" />
      </div>
      <div class="col-md-2">
        <label class="form-label text-muted small">‡πÄ‡∏£‡∏ó‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á (‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏¥‡∏ß)</label>
        <input type="number" step="0.01" name="shipping_rate_thb_cbm"
          class="form-control bg-dark text-white border-secondary" value="{{ po.shipping_rate_thb_cbm }}" />
      </div>
      <div class="col-md-2">
        <label class="form-label text-muted small">‡∏¢‡∏≠‡∏î‡∏´‡∏¢‡∏ß‡∏ô‡∏£‡∏ß‡∏° (Total Yuan)</label>
        <input type="number" step="0.01" name="total_yuan"
          class="form-control bg-dark text-white border-secondary fw-bold text-success" value="{{ po.total_yuan }}" />
        <small class="text-muted">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡∏°‡πà (Triggers Proration)</small>
      </div>
      {% endif %}

      {% if po.order_type == 'DOMESTIC' %}
      <div class="col-md-2">
        <label class="form-label text-muted small">VAT (%)</label>
        <input type="number" step="0.01" name="vat_rate" class="form-control bg-dark text-white border-secondary"
          value="{{ po.vat_rate|default:'7.00' }}" />
      </div>
      {% endif %}
    </div>
    

  </div>
  </div>
</form>

<!-- Items Table Form -->
<form method="post" id="itemsForm">
  {% csrf_token %}
  <input type="hidden" name="action" value="update_items" />

  <div class="card shadow-sm border-secondary">
    <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center">
      <h5 class="mb-0 text-white">
        <i class="bi bi-list-check"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Items)
      </h5>

      <!-- Top Inputs Removed (Moved to Table) -->
      <div class="d-flex gap-2 align-items-end">
        {% comment %} <span class="text-muted small">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span> {% endcomment %}
        <button type="submit" class="btn btn-sm btn-primary text-nowrap px-3 shadow-sm">
          <i class="bi bi-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Items)
        </button>
        <!-- Add Item Button -->
        <button type="button" class="btn btn-sm btn-outline-warning text-nowrap" data-bs-toggle="modal"
          data-bs-target="#addItemModal">
          <i class="bi bi-plus-lg me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </button>
      </div>
    </div>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle mb-0 table-bordered" style="border-color: #444;">
        <thead>
          <tr class="text-center align-middle">
            <th rowspan="3" class="bg-secondary bg-opacity-10" style="width: 100px">‡∏£‡∏π‡∏õ</th>
            <th rowspan="3" class="bg-secondary bg-opacity-10">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
            <th rowspan="3" class="bg-secondary bg-opacity-10" style="width: 100px">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡πà‡∏á</th>

            
            <th rowspan="3" class="bg-secondary bg-opacity-10" style="width: 100px">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
            <th rowspan="3" class="bg-secondary bg-opacity-10" style="width: 100px">‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
            {% comment %} {% if po.order_type == 'DOMESTIC' %}
            {% endif %} {% endcomment %}

            <th rowspan="3" class="bg-success bg-opacity-25 border-success text-white" style="width: 120px">
              <div class="fw-bold">‡∏£‡∏ß‡∏°</div>
              <div class="small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</div>
            </th>

            {% for col in batch_columns %}
            <th colspan="3" class="border-bottom-0"
              style="min-width: 200px; background-color: {% if col.no|divisibleby:2 %}#1a3d3d{% else %}#2c3e50{% endif %};">
              <div class="fw-bold text-info mb-1">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà {{ col.no }}</div>

              <div class="d-flex flex-column gap-1 mb-1">
                <div class="input-group input-group-sm">
                  <span class="input-group-text bg-secondary text-white border-0"
                    style="font-size: 10px; width: 35px;">Bill</span>
                  <input type="date" name="batch_{{ col.no }}_bill_date"
                    value="{{ col.obj.bill_date|date:'Y-m-d'|default:'' }}"
                    class="form-control bg-dark text-white border-secondary p-1" style="font-size: 0.75rem;">
                </div>
                <div class="input-group input-group-sm">
                  <span class="input-group-text bg-secondary text-white border-0"
                    style="font-size: 10px; width: 35px;">‡∏£‡∏±‡∏ö</span>
                  <input type="date" name="batch_{{ col.no }}_recv_date"
                    value="{{ col.obj.received_date|date:'Y-m-d'|default:'' }}"
                    class="form-control bg-dark text-white border-secondary p-1" style="font-size: 0.75rem;">
                </div>
              </div>
            </th>
            {% endfor %}
          </tr>

          <tr class="text-center">
            {% for col in batch_columns %}
            <th colspan="3" class="p-1 border-top-0"
              style="background-color: {% if col.no|divisibleby:2 %}#1a3d3d{% else %}#2c3e50{% endif %};">
              <div class="d-flex gap-1">
                <div class="input-group input-group-sm">
                  <span class="input-group-text bg-dark text-muted border-secondary px-1"
                    style="font-size: 9px;">‡∏Ñ‡∏¥‡∏ß</span>
                  <input type="number" step="0.0001" name="batch_{{ col.no }}_total_cbm"
                    value="{{ col.obj.total_cbm|default:'' }}"
                    class="form-control bg-dark text-white border-secondary p-1 text-center" placeholder="0">
                </div>
                <div class="input-group input-group-sm">
                  <span class="input-group-text bg-dark text-muted border-secondary px-1"
                    style="font-size:9px;">KG</span>
                  <input type="number" step="0.01" name="batch_{{ col.no }}_total_kg"
                    value="{{ col.obj.total_weight|default:'' }}"
                    class="form-control bg-dark text-white border-secondary p-1 text-center" placeholder="0">
                </div>
              </div>
            </th>
            {% endfor %}
          </tr>

          <tr class="text-center small text-muted" style="font-size: 0.65rem;">
            {% for col in batch_columns %}
            <th class="border-secondary"
              style="width: 70px; background-color: {% if col.no|divisibleby:2 %}#1a3d3d{% else %}#2c3e50{% endif %};">
              ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th class="border-secondary"
              style="width: 65px; background-color: {% if col.no|divisibleby:2 %}#1a3d3d{% else %}#2c3e50{% endif %};">
              ‡∏Ñ‡∏¥‡∏ß</th>
            <th class="border-secondary"
              style="width: 65px; background-color: {% if col.no|divisibleby:2 %}#1a3d3d{% else %}#2c3e50{% endif %};">
              KG</th>
            {% endfor %}
          </tr>
        </thead>

        <tbody>
          {% for item in items %}
          <tr>
            <td class="text-center">
              {% if item.sku.image %}
              <img src="{{ item.sku.image.url }}" style="height: 80px; width: 80px; object-fit: cover;"
                class="rounded border border-secondary" />
              {% else %}
              <div class="bg-secondary rounded " style="height: 80px; width: 80px;"></div>
              {% endif %}
            </td>
            <td>
              <div class="fw-bold small text-info">{{ item.sku.product_code }}</div>
              <div class="small text-muted" style="font-size: 0.7rem;">{{ item.sku.name|truncatechars:25 }}</div>
            </td>
            <td class="text-center bg-secondary bg-opacity-10">
              <div class="fw-bold">{{ item.qty_ordered }}</div>
              <div class="text-warning" style="font-size: 0.7rem;">Left: {{ item.remaining_qty }}</div>
            </td>
            <td class="text-end bg-secondary bg-opacity-10">
              <div class="small">{{ item.unit_cost_thb|floatformat:2|intcomma }}</div>
            </td>
            <td class="text-end bg-secondary bg-opacity-10">
              <!-- Calculate Total: Price * Qty + VAT. Using price_baht which should store this -->
              <div class="fw-bold text-success">{{ item.price_baht|floatformat:2|intcomma }}</div>
            </td>
            {% comment %} {% if po.order_type == 'DOMESTIC' %}
            {% endif %} {% endcomment %}

            <td class="bg-success bg-opacity-10 border-success p-2">
              <div
                class="d-flex justify-content-between small text-white border-bottom border-success border-opacity-25 mb-1">
                <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</span> <span class="badge bg-success px-1">{{ item.sum_qty }}</span>
              </div>
              <div
                class="d-flex justify-content-between small text-white border-bottom border-success border-opacity-25 mb-1">
                <span>‡∏Ñ‡∏¥‡∏ß:</span> <span class="fw-bold">{{ item.sum_cbm|floatformat:2 }}</span>
              </div>
              <div class="d-flex justify-content-between small text-white mb-1">
                <span>KG:</span> <span class="fw-bold">{{ item.sum_weight|floatformat:2 }}</span>
              </div>
            </td>

            {% for val in item.batch_values %}
            {% with bg_color=forloop.counter|divisibleby:2|yesno:"#1a2a2a,#252525" %}

            <td class="p-1" style="background-color: {{ bg_color }};">
              <input type="number" name="receive_qty_{{ item.id }}_{{ forloop.counter }}"
                class="form-control form-control-sm bg-dark text-white border-secondary text-center px-1"
                value="{{ val.qty }}" min="0" placeholder="0">
            </td>

            <td class="text-center p-1" style="background-color: {{ bg_color }};">
              <span class="text-muted" style="font-size: 0.7rem;">
                {{ val.cbm|floatformat:2|default:"-" }}
              </span>
            </td>

            <td class="text-center p-1" style="background-color: {{ bg_color }};">
              <span class="text-muted" style="font-size: 0.7rem;">
                {{ val.weight|floatformat:2|default:"-" }}
              </span>
            </td>

            {% endwith %}
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  </div>
</form>

<script>
  function onCheckboxChange(itemId) {
    const checkbox = document.getElementById("chk_" + itemId);
    const input = document.getElementById("qty_" + itemId);

    if (checkbox.checked) {
      if (!input.value) {
        input.value = input.getAttribute("data-remaining");
      }
      input.focus();
    } else {
      input.value = "";
    }
  }

  function onInputChange(itemId) {
    const checkbox = document.getElementById("chk_" + itemId);
    const input = document.getElementById("qty_" + itemId);
    const val = parseFloat(input.value);

    if (val > 0) {
      checkbox.checked = true;
    } else {
      checkbox.checked = false;
    }
  }

  document.getElementById("selectAll").addEventListener("change", function () {
    const checkboxes = document.querySelectorAll(".item-check");
    checkboxes.forEach((cb) => {
      const itemId = cb.getAttribute("id").split("_")[1];
      cb.checked = this.checked;
      onCheckboxChange(itemId);
    });
  });
</script>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white border-secondary">
      <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_item">

        <div class="modal-header border-secondary">
          <h5 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Add Item)</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Search SKU / Name</label>
            <input type="text" name="sku_code" class="form-control bg-dark text-white border-secondary"
              placeholder="Enter SKU" required list="skuOptions">
            <datalist id="skuOptions">
              {% for m in master_items %}
              <option value="{{ m.product_code }}">{{ m.name }}</option>
              {% endfor %}
            </datalist>
          </div>
          <div class="row">
            <div class="col-4">
              <label class="form-label">Qty</label>
              <input type="number" name="new_qty" class="form-control bg-dark text-white border-secondary" value="1"
                min="1" required>
            </div>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Add Item</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">
          <i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Receiving History)
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-dark table-sm table-hover">
            <thead>
              <tr>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th>
                <th>SKU</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="text-end">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Qty)</th>
                <th class="text-end">‡∏Ñ‡∏¥‡∏ß</th>
                <th class="text-end">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (KG)</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody>
              {% for item in po.items.all %}
              {% for receipt in item.receipts.all %}
              <tr>
                <td>{{ receipt.received_date|date:"d/m/Y" }}</td>
                <td class="fw-bold">{{ item.sku.product_code }}</td>
                <td>{{ item.sku.name|truncatechars:40 }}</td>
                <td class="text-end">{{ receipt.received_qty }}</td>
                <td class="text-end">
                  {{ receipt.received_cbm|floatformat:4 }}
                </td>
                <td class="text-end">
                  {{ receipt.received_weight|floatformat:2 }}
                </td>
                <td class="text-center">
                  <form action="{% url 'delete_received_item' receipt.id %}" method="post"
                    onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger px-2 py-0"><i class="bi bi-trash"></i></button>
                  </form>
                </td>
              </tr>
              {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}