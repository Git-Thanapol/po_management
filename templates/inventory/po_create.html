{% extends 'base.html' %} {% load humanize %} {% block title %}‡∏™‡∏£‡πâ‡∏≤‡∏á PO ‡πÉ‡∏´‡∏°‡πà
(Create PO){% endblock %} {% block content %}
<div class="row">
  <div class="col-12">
    <h2 class="mb-4">üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà (Create Purchase Order)</h2>

    <form method="POST" enctype="multipart/form-data" id="poForm">
      {% csrf_token %}

      <!-- 1. Header Information -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (Header Info)
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-2">
              <label class="form-label">‡πÄ‡∏•‡∏Ç PO (PO Number) <span class="text-danger">*</span></label>
              <input type="text" name="po_number" class="form-control" required placeholder="Ex. PO-2024-001" />
            </div>
            <div class="col-md-2">
              <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Order Date)
                <span class="text-danger">*</span></label>
              <input type="date" name="order_date" class="form-control" value="{% now 'Y-m-d' %}" required
                id="order_date" />
            </div>
            <div class="col-md-2">
              <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Order Type) <span class="text-danger">*</span></label>
              <select name="order_type" class="form-select" id="order_type" required onchange="toggleImportFields()">
                <option value="IMPORTED">Imported (‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤)</option>
                <option value="DOMESTIC">Domestic (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)</option>
              </select>
            </div>
            <div class="col-md-2 import-field">
              <label class="form-label">‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á (Shipping)</label>
              <select name="shipping_type" class="form-select" id="shipping_type" onchange="calcEstimatedDate()">
                <option value="CAR">Car (‡∏£‡∏ñ)</option>
                <option value="SHIP">Ship (‡πÄ‡∏£‡∏∑‡∏≠)</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (Est. Date)
                <span class="text-danger">*</span></label>
              <input type="date" name="estimated_date" class="form-control" id="estimated_date" required />
            </div>
            <div class="col-md-2">
              <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö (Bill Date) <span class="badge bg-info">New</span></label>
              <input type="date" name="bill_date" class="form-control" />
            </div>
          </div>
        </div>
      </div>

      <!-- 2. Supplier / Pricing Ref -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0">
            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ (Supplier / Pricing Ref)
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Link Shop</label>
              <input type="text" name="link_shop" class="form-control" placeholder="URL ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏µ‡∏ô..." />
            </div>
            <div class="col-md-4">
              <label class="form-label">WeChat / Contact</label>
              <input type="text" name="wechat_contact" class="form-control" />
            </div>
            <div class="col-md-4">
              <label class="form-label">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (Attach Files)</label>
              <input type="file" name="attachments" multiple class="form-control" />
            </div>

            <div class="col-md-3">
              <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ Shopee (Ref)</label>
              <input type="number" step="0.01" name="shopee_price" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ Lazada (Ref)</label>
              <input type="number" step="0.01" name="lazada_price" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ TikTok (Ref)</label>
              <input type="number" step="0.01" name="tiktok_price" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Note)</label>
              <textarea name="note" class="form-control" rows="1"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. Financial -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0">
            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (Financial)
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">‡πÄ‡∏£‡∏ó‡πÄ‡∏á‡∏¥‡∏ô (Exchange Rate)</label>
              <input type="number" step="0.0001" name="exchange_rate" id="exchange_rate" class="form-control"
                value="5.0" oninput="recalcAll()" />
            </div>
            <div class="col-md-4">
              <label class="form-label">‡πÄ‡∏£‡∏ó‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á THB/‡∏Ñ‡∏¥‡∏ß</label>
              <input type="number" step="0.01" name="shipping_rate_thb_cbm" class="form-control" value="0" />
            </div>
            <div class="col-md-4">
              <label class="form-label">‡∏¢‡∏≠‡∏î‡∏´‡∏¢‡∏ß‡∏ô‡∏£‡∏ß‡∏° (Total Yuan)</label>
              <input type="number" step="0.01" name="total_yuan" id="total_yuan" class="form-control" value="0"
                oninput="recalcAll()" />
              <small class="text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏¢‡∏≠‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Prorate to Items)</small>
            </div>
          </div>
        </div>
      </div>

      <!-- 4. Items Table -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-box-seam"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Items)
          </h5>
          <button type="button" class="btn btn-sm btn-light" onclick="addItemRow()">
            <i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß (Add Row)
          </button>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered mb-0" id="itemsTable" style="font-size: 0.9rem">
              <thead class="table-grey text-center">
                <tr>
                  <th style="width: 250px">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)</th>
                  <th style="width: 100px">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                  <!-- Proration Preview Columns -->
                  <th class="import-col" style="width: 120px">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (¬•)</th>
                  <th class="import-col" style="width: 120px">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° (¬•)</th>
                  <th class="import-col" style="width: 120px">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° (‡∏ø)</th>
                  <th style="width: 50px">üóëÔ∏è</th>
                </tr>
              </thead>
              <tbody id="itemsBody">
                <!-- JS will populate rows here -->
              </tbody>
              <tfoot class="table-grey text-center fw-bold">
                <tr>
                  <td class="text-end">‡∏£‡∏ß‡∏°:</td>
                  <td><span id="sumQty">0</span></td>
                  <td class="import-col"></td>
                  <td class="import-col"><span id="sumYuan">0.00</span></td>
                  <td class="import-col"><span id="sumBaht">0.00</span></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div class="d-flex justify-content-end gap-2 mb-5">
        <a href="{% url 'po_list' %}" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (Cancel)</a>
        <button type="submit" class="btn btn-success btn-lg">
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏• (Create PO)
        </button>
      </div>

      <!-- Hidden inputs needed for form logic -->
      <input type="hidden" name="total_items" id="total_items" value="0" />
    </form>
  </div>
</div>

<!-- Template for SKU Options (Hidden) -->
<datalist id="skuList">
  {% for item in master_items %}
  <option value="{{ item.product_code }}">{{ item.name }}</option>
  {% endfor %}
</datalist>

{% endblock %} {% block extra_js %}
<script>
  let rowCount = 0;

  function addItemRow() {
    rowCount++;
    const tbody = document.getElementById("itemsBody");
    const tr = document.createElement("tr");
    tr.id = `row-${rowCount}`;
    tr.innerHTML = `
            <td>
                <input list="skuList" name="sku_${rowCount}" class="form-control form-control-sm" required placeholder="Type SKU...">
            </td>
            <td>
                <input type="number" name="qty_${rowCount}" class="form-control form-control-sm text-center" min="1" value="1" oninput="recalcAll()">
            </td>
            <td class="import-col">
                 <input type="text" id="view_unit_yuan_${rowCount}" class="form-control form-control-sm text-end border-0 bg-transparent" readonly value="0.00">
            </td>
             <td class="import-col">
                 <input type="text" id="view_total_yuan_${rowCount}" class="form-control form-control-sm text-end border-0 bg-transparent" readonly value="0.00">
            </td>
             <td class="import-col">
                 <input type="text" id="view_total_baht_${rowCount}" class="form-control form-control-sm text-end border-0 bg-transparent" readonly value="0.00">
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger border-0" onclick="removeRow(${rowCount})">√ó</button>
            </td>
        `;
    tbody.appendChild(tr);
    document.getElementById("total_items").value = rowCount;
    recalcAll();
  }

  function removeRow(id) {
    document.getElementById(`row-${id}`).remove();
    recalcAll();
  }

  function toggleImportFields() {
    // Logic if we want to hide Sections based on Type
    // The prompt says "Section 1..3", assumes usually visible.
    // We can keep them visible or follow old logic.
    // Old logic hid 'import-field'.
    // User Section 3 "Financial" implies needed for Import.
    // Domestic might not need Total Yuan?
    // Let's assume always visible for now to match user request structure.
  }

  function calcEstimatedDate() {
    const orderDate = new Date(document.getElementById("order_date").value);
    const shipType = document.getElementById("shipping_type").value;
    let days = 0;

    if (shipType === "CAR") days = 14;
    if (shipType === "SHIP") days = 25;

    if (days > 0 && !isNaN(orderDate.getTime())) {
      orderDate.setDate(orderDate.getDate() + days);
      document.getElementById("estimated_date").valueAsDate = orderDate;
    }
  }

  document.getElementById("order_date").addEventListener("change", calcEstimatedDate);

  function recalcAll() {
    // 1. Get Global Values
    const headerTotalYuan = parseFloat(document.getElementById("total_yuan").value) || 0;
    const exchangeRate = parseFloat(document.getElementById("exchange_rate").value) || 1.0;

    // 2. Calculate Total Qty
    let sumQty = 0;
    const qtyInputs = document.querySelectorAll('input[name^="qty_"]');
    qtyInputs.forEach(inp => {
      sumQty += parseFloat(inp.value) || 0;
    });

    // 3. Update Rows (Proration)
    let checkSumYuan = 0;

    qtyInputs.forEach(inp => {
      const id = inp.name.split('_')[1];
      const qty = parseFloat(inp.value) || 0;

      let lineTotalYuan = 0;
      let unitYuan = 0;

      if (sumQty > 0 && headerTotalYuan > 0) {
        // Proration Formula
        const ratio = qty / sumQty;
        lineTotalYuan = headerTotalYuan * ratio;
        if (qty > 0) unitYuan = lineTotalYuan / qty;
      }

      const lineTotalBaht = lineTotalYuan * exchangeRate;

      // Update View Inputs
      document.getElementById(`view_unit_yuan_${id}`).value = unitYuan.toFixed(4);
      document.getElementById(`view_total_yuan_${id}`).value = lineTotalYuan.toFixed(2);
      document.getElementById(`view_total_baht_${id}`).value = lineTotalBaht.toFixed(2);

      checkSumYuan += lineTotalYuan;
    });

    // 4. Update Footer Totals
    document.getElementById("sumQty").innerText = sumQty;
    document.getElementById("sumYuan").innerText = checkSumYuan.toFixed(2);
    document.getElementById("sumBaht").innerText = (checkSumYuan * exchangeRate).toFixed(2);
  }

  // Init
  addItemRow(); // Start with one row
</script>
{% endblock %}