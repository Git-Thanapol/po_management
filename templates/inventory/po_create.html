{% extends 'base.html' %} {% load humanize %} {% block title %}‡∏™‡∏£‡πâ‡∏≤‡∏á PO ‡πÉ‡∏´‡∏°‡πà
(Create PO){% endblock %} {% block content %}
<div class="row">
  <div class="col-12">
    <h2 class="mb-4">üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà (Create Purchase Order)</h2>

    <form method="POST" enctype="multipart/form-data" id="poForm">
      {% csrf_token %}

      <!-- 1. Header Information -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (Header Info)
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label"
                >‡πÄ‡∏•‡∏Ç PO (PO Number) <span class="text-danger">*</span></label
              >
              <input
                type="text"
                name="po_number"
                class="form-control"
                required
                placeholder="Ex. PO-2024-001"
              />
            </div>
            <div class="col-md-3">
              <label class="form-label"
                >‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Order Date)
                <span class="text-danger">*</span></label
              >
              <input
                type="date"
                name="order_date"
                class="form-control"
                value="{% now 'Y-m-d' %}"
                required
                id="order_date"
              />
            </div>
            <div class="col-md-3">
              <label class="form-label"
                >‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Order Type) <span class="text-danger">*</span></label
              >
              <select
                name="order_type"
                class="form-select"
                id="order_type"
                required
                onchange="toggleImportFields()"
              >
                <option value="IMPORTED">Imported (‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤)</option>
                <option value="DOMESTIC">Domestic (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)</option>
              </select>
            </div>
            <div class="col-md-3 import-field">
              <label class="form-label"
                >‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á (Shipping) <span class="text-danger">*</span></label
              >
              <select
                name="shipping_type"
                class="form-select"
                id="shipping_type"
                onchange="calcEstimatedDate()"
                required
              >
                <option value="CAR">Car (‡∏£‡∏ñ)</option>
                <option value="SHIP">Ship (‡πÄ‡∏£‡∏∑‡∏≠)</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label"
                >‡∏ß‡∏±‡∏ô‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (Est. Date)
                <span class="text-danger">*</span></label
              >
              <input
                type="date"
                name="estimated_date"
                class="form-control"
                id="estimated_date"
                required
              />
            </div>

            <!-- Import Only Fields -->
            <div class="col-md-3 import-field">
              <label class="form-label"
                >‡πÄ‡∏£‡∏ó‡πÄ‡∏á‡∏¥‡∏ô (Exchange Rate)
                <span class="text-danger">*</span></label
              >
              <input
                type="number"
                step="0.0001"
                name="exchange_rate"
                id="exchange_rate"
                class="form-control"
                value="5.0"
                oninput="recalcAll()"
                required
              />
            </div>
            <div class="col-md-3 import-field">
              <label class="form-label">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á/CBM (‡∏´‡∏¢‡∏ß‡∏ô)</label>
              <input
                type="number"
                step="0.01"
                name="shipping_rate_yuan_per_cbm"
                class="form-control"
                value="0"
              />
            </div>
          </div>

          <hr class="my-4" />

          <!-- Supplier / Reference Info -->
          <h6 class="text-muted mb-3">
            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ (Supplier / Pricing Ref)
          </h6>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Link Shop</label>
              <input
                type="text"
                name="link_shop"
                class="form-control"
                placeholder="URL ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏µ‡∏ô..."
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">WeChat / Contact</label>
              <input type="text" name="wechat_contact" class="form-control" />
            </div>
            <div class="col-md-4">
              <label class="form-label">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (Attach Files)</label>
              <input
                type="file"
                name="attachments"
                multiple
                class="form-control"
              />
            </div>

            <div class="col-md-3">
              <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ Shopee (Ref)</label>
              <input
                type="number"
                step="0.01"
                name="shopee_price"
                class="form-control"
              />
            </div>
            <div class="col-md-3">
              <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ Lazada (Ref)</label>
              <input
                type="number"
                step="0.01"
                name="lazada_price"
                class="form-control"
              />
            </div>
            <div class="col-md-3">
              <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ TikTok (Ref)</label>
              <input
                type="number"
                step="0.01"
                name="tiktok_price"
                class="form-control"
              />
            </div>
            <div class="col-md-3">
              <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Note)</label>
              <textarea name="note" class="form-control" rows="1"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- 2. Items Table -->
      <div class="card mb-4 shadow-sm">
        <div
          class="card-header bg-dark text-white d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">
            <i class="bi bi-box-seam"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Items)
          </h5>
          <button
            type="button"
            class="btn btn-sm btn-light"
            onclick="addItemRow()"
          >
            <i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß (Add Row)
          </button>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table
              class="table table-bordered mb-0"
              id="itemsTable"
              style="font-size: 0.9rem"
            >
              <thead class="table-grey text-center">
                <tr>
                  <th style="width: 200px">SKU</th>
                  <th style="width: 80px">Qty</th>
                  <th class="import-col" style="width: 100px">Price (¬•)</th>
                  <th class="import-col" style="width: 100px">Total (¬•)</th>
                  <th style="width: 100px">Total (‡∏ø)</th>
                  <!-- Removed W/L/H -->
                  <th style="width: 80px">‡∏Ñ‡∏¥‡∏ß CBM</th>
                  <th style="width: 80px">KG</th>
                  <th style="width: 50px">üóëÔ∏è</th>
                </tr>
              </thead>
              <tbody id="itemsBody">
                <!-- JS will populate rows here -->
              </tbody>
              <tfoot class="table-grey text-center fw-bold">
                <tr>
                  <td class="text-end">‡∏£‡∏ß‡∏°:</td>
                  <td><span id="sumQty">0</span></td>
                  <td class="import-col">
                    <span id="avgPriceYuan">0.00</span>
                  </td>
                  <td class="import-col"><span id="sumYuan">0.00</span></td>
                  <td><span id="sumBaht">0.00</span></td>
                  <td><span id="sumCBM">0.0000</span></td>
                  <td><span id="sumKG">0.00</span></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div class="d-flex justify-content-end gap-2 mb-5">
        <a href="{% url 'po_list' %}" class="btn btn-secondary"
          >‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (Cancel)</a
        >
        <button type="submit" class="btn btn-success btn-lg">
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏• (Create PO)
        </button>
      </div>

      <!-- Hidden inputs needed for form logic -->
      <input type="hidden" name="total_items" id="total_items" value="0" />
    </form>
  </div>
</div>

<!-- Template for SKU Options (Hidden) -->
<datalist id="skuList">
  {% for item in master_items %}
  <option value="{{ item.product_code }}">{{ item.name }}</option>
  {% endfor %}
</datalist>

{% endblock %} {% block extra_js %}
<script>
  let rowCount = 0;

  function addItemRow() {
    rowCount++;
    const tbody = document.getElementById("itemsBody");
    const tr = document.createElement("tr");
    tr.id = `row-${rowCount}`;
    tr.innerHTML = `
            <td>
                <input list="skuList" name="sku_${rowCount}" class="form-control form-control-sm" required placeholder="Type SKU...">
            </td>
            <td>
                <input type="number" name="qty_${rowCount}" class="form-control form-control-sm text-center" min="1" value="1" oninput="calcRow(${rowCount})">
            </td>
            <td class="import-col">
                <input type="number" name="yuan_${rowCount}" class="form-control form-control-sm text-end" step="0.01" value="0" oninput="calcRow(${rowCount})">
            </td>
            <td class="import-col">
                <input type="number" name="total_yuan_${rowCount}" class="form-control form-control-sm text-end bg-secondary text-white" readonly step="0.01" value="0">
            </td>
            <td>
                <input type="number" name="baht_${rowCount}" class="form-control form-control-sm text-end" step="0.01" value="0" oninput="updateTotals()">
            </td>
            <!-- Removed W/L/H inputs -->
            <td>
                <input type="number" name="cbm_${rowCount}" class="form-control form-control-sm px-1 bg-dark text-white text-center" step="0.0001" oninput="updateTotals()">
            </td>
            <td>
                 <input type="number" name="kg_${rowCount}" class="form-control form-control-sm px-1 text-center" step="0.01" oninput="updateTotals()">
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger border-0" onclick="removeRow(${rowCount})">√ó</button>
            </td>
        `;
    tbody.appendChild(tr);
    document.getElementById("total_items").value = rowCount;
    toggleImportFields(); // Ensure visibility
  }

  function removeRow(id) {
    document.getElementById(`row-${id}`).remove();
    updateTotals();
  }

  function toggleImportFields() {
    const type = document.getElementById("order_type").value;
    const isImport = type === "IMPORTED";

    // Show/Hide Header Fields
    document.querySelectorAll(".import-field").forEach((el) => {
      el.style.display = isImport ? "block" : "none";
    });

    // Show/Hide Column (Price Yuan)
    // We use visibility or display. For table columns, display:none works but need to handle header index carefully.
    // Simplest: Add class to TH and TD cells.
    document.querySelectorAll(".import-col").forEach((el) => {
      el.style.display = isImport ? "table-cell" : "none";
    });

    recalcAll();
  }

  function calcEstimatedDate() {
    const orderDate = new Date(document.getElementById("order_date").value);
    const shipType = document.getElementById("shipping_type").value;
    let days = 0;

    if (shipType === "CAR") days = 14;
    if (shipType === "SHIP") days = 25;

    if (days > 0 && !isNaN(orderDate.getTime())) {
      orderDate.setDate(orderDate.getDate() + days);
      document.getElementById("estimated_date").valueAsDate = orderDate;
    }
  }

  // Auto trigger on date change too
  document
    .getElementById("order_date")
    .addEventListener("change", calcEstimatedDate);

  // Removed calcCBM function logic as W/L/H are removed.
  // CBM is now direct input.

  function calcRow(id) {
    const type = document.getElementById("order_type").value;
    const rate =
      parseFloat(document.getElementById("exchange_rate").value) || 1.0;

    const qty =
      parseFloat(document.querySelector(`[name="qty_${id}"]`).value) || 0;
    const yuan =
      parseFloat(document.querySelector(`[name="yuan_${id}"]`).value) || 0;

    // Update Total Yuan
    const totalYuanInput = document.querySelector(`[name="total_yuan_${id}"]`);
    const totalYuan = yuan * qty;
    totalYuanInput.value = totalYuan.toFixed(2);

    const bahtInput = document.querySelector(`[name="baht_${id}"]`);

    if (type === "IMPORTED") {
      const totalBaht = totalYuan * rate;
      bahtInput.value = totalBaht.toFixed(2);
    }

    updateTotals();
  }

  function recalcAll() {
    const inputs = document.querySelectorAll('input[name^="qty_"]');
    inputs.forEach((input) => {
      const id = input.name.split("_")[1];
      calcRow(id);
    });
    updateTotals();
  }

  function updateTotals() {
    let sumQty = 0;
    let sumUnitYuan = 0; // For Avg calculation
    let countItems = 0;
    let sumTotalYuan = 0;
    let sumBaht = 0;
    let sumCBM = 0;
    let sumKG = 0;

    const inputs = document.querySelectorAll('input[name^="qty_"]');
    inputs.forEach((input) => {
      const id = input.name.split("_")[1];
      const qty = parseFloat(input.value) || 0;
      const yuan =
        parseFloat(document.querySelector(`[name="yuan_${id}"]`).value) || 0;
      const totalYuan =
        parseFloat(document.querySelector(`[name="total_yuan_${id}"]`).value) ||
        0;
      const baht =
        parseFloat(document.querySelector(`[name="baht_${id}"]`).value) || 0;
      const cbm =
        parseFloat(document.querySelector(`[name="cbm_${id}"]`).value) || 0;
      const kg =
        parseFloat(document.querySelector(`[name="kg_${id}"]`).value) || 0;

      sumQty += qty;
      countItems += 1;
      sumUnitYuan += yuan; // Simple sum for now, will divide by countItems logic or total logic

      sumTotalYuan += totalYuan;
      sumBaht += baht;

      // CBM and KG: User input is per Unit or Total?
      // In `calcRow` we had `sumCBM += cbm * qty` logic previously.
      // But now CBM is direct input.
      // If user types "50" in CBM column for 10 items. Is that 50 total or 50 per item?
      // Usually "CBM" column in a list implies "Total CBM for this line".
      // Especially if it was auto-calculated from W*L*H*Qty before.
      // Let's assume the input is the TOTAL CBM for that line.
      // Why? Because if they have a packing list, it usually says "Total Volume".
      // AND, the `total_yuan` is a calculated total.
      // Let's assume Input = Total CBM for the line.
      sumCBM += cbm;
      sumKG += kg;
    });

    // Avg Price Yuan calculation
    let avgPrice = 0;
    if (sumQty > 0) {
      // Weighted Average = Total Value / Total Qty
      avgPrice = sumTotalYuan / sumQty;
    } else if (countItems > 0) {
      // Fallback to simple avg if qty 0
      avgPrice = sumUnitYuan / countItems;
    }

    document.getElementById("sumQty").innerText = sumQty;
    document.getElementById("avgPriceYuan").innerText = avgPrice.toFixed(2);
    document.getElementById("sumYuan").innerText = sumTotalYuan.toFixed(2);
    document.getElementById("sumBaht").innerText = sumBaht.toFixed(2);
    document.getElementById("sumCBM").innerText = sumCBM.toFixed(4);
    document.getElementById("sumKG").innerText = sumKG.toFixed(2);
  }

  // Init
  addItemRow();
  toggleImportFields();

  // AJAX Submit Handler
  document.getElementById("poForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerText;

    submitBtn.disabled = true;
    submitBtn.innerText = "Saving...";

    fetch("", {
      method: "POST",
      body: formData,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          window.location.href = data.redirect_url;
        } else {
          alert(data.message || "An error occurred.");
          submitBtn.disabled = false;
          submitBtn.innerText = originalText;
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Network error or server failed to respond.");
        submitBtn.disabled = false;
        submitBtn.innerText = originalText;
      });
  });
</script>
{% endblock %}
