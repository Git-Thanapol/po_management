{% extends 'base.html' %} {% load humanize %} {% block title %}‡∏™‡∏£‡πâ‡∏≤‡∏á PO ‡πÉ‡∏´‡∏°‡πà
(Create PO){% endblock %} {% block content %}
<div class="row">
  <div class="col-12">
    <h2 class="mb-4">üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà (Create Purchase Order)</h2>

    <form method="POST" enctype="multipart/form-data" id="poForm">
      {% csrf_token %}

      <!-- 1. Header Information -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (Header Info)
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-2">
              <label class="form-label">‡πÄ‡∏•‡∏Ç PO (PO Number) <span class="text-danger">*</span></label>
              <input type="text" name="po_number" class="form-control" required placeholder="Ex. PO-2024-001" />
            </div>
            <div class="col-md-2">
              <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Order Date)
                <span class="text-danger">*</span></label>
              <input type="date" name="order_date" class="form-control" value="{% now 'Y-m-d' %}" required
                id="order_date" />
            </div>
            <div class="col-md-2">
              <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Order Type) <span class="text-danger">*</span></label>
              <select name="order_type" class="form-select" id="order_type" required onchange="toggleImportFields()">
                <option value="IMPORTED">Imported (‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤)</option>
                <option value="DOMESTIC">Domestic (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)</option>
              </select>
            </div>
            <div class="col-md-2 import-field">
              <label class="form-label">‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á (Shipping)</label>
              <select name="shipping_type" class="form-select" id="shipping_type" onchange="calcEstimatedDate()">
                <option value="CAR">Car (‡∏£‡∏ñ)</option>
                <option value="SHIP">Ship (‡πÄ‡∏£‡∏∑‡∏≠)</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label" id="date_label_ref">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
              <input type="date" name="estimated_date" class="form-control" id="estimated_date" />
            </div>
            <div class="col-md-2">
              <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö (Bill Date) <span class="badge bg-info">New</span></label>
              <input type="date" name="bill_date" class="form-control" />
            </div>
          </div>
        </div>
      </div>

      <!-- 2. Supplier / Pricing Ref -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0">
            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ (Supplier / Pricing Ref)
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Link Shop</label>
              <input type="text" name="link_shop" class="form-control" placeholder="URL ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏µ‡∏ô..." />
            </div>
            <div class="col-md-4">
              <label class="form-label">WeChat / Contact</label>
              <input type="text" name="wechat_contact" class="form-control" />
            </div>
            <div class="col-md-4">
              <label class="form-label">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (Attach Files)</label>
              <input type="file" name="attachments" multiple class="form-control" />
            </div>

            <div class="col-md-3">
              <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ Shopee (Ref)</label>
              <input type="number" step="0.01" name="shopee_price" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ Lazada (Ref)</label>
              <input type="number" step="0.01" name="lazada_price" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ TikTok (Ref)</label>
              <input type="number" step="0.01" name="tiktok_price" class="form-control" />
            </div>

            <div class="col-md-3">
              <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Note)</label>
              <textarea name="note" class="form-control" rows="1"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. Financial -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0">
            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (Financial)
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">‡πÄ‡∏£‡∏ó‡πÄ‡∏á‡∏¥‡∏ô (Exchange Rate)</label>
              <input type="number" step="0.0001" name="exchange_rate" id="exchange_rate" class="form-control"
                value="5.0" oninput="recalcAll()" />
            </div>
            <div class="col-md-4">
              <label class="form-label">‡πÄ‡∏£‡∏ó‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á THB/‡∏Ñ‡∏¥‡∏ß</label>
              <input type="number" step="0.01" name="shipping_rate_thb_cbm" class="form-control" value="0" />
            </div>
            <div class="col-md-4">
              <label class="form-label">‡∏¢‡∏≠‡∏î‡∏´‡∏¢‡∏ß‡∏ô‡∏£‡∏ß‡∏° (Total Yuan)</label>
              <input type="number" step="0.01" name="total_yuan" id="total_yuan" class="form-control" value="0"
                oninput="recalcAll()" />
              <small class="text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏¢‡∏≠‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Prorate to Items)</small>
            </div>
            <div class="col-md-3 domestic-field">
              <label class="form-label">VAT</label>
              <div class="input-group">
                <span class="input-group-text">‡∏°‡∏µ VAT</span>
                <input type="number" step="0.01" name="vat_rate" id="vat_rate" class="form-control" value="7.00"
                  oninput="recalcAll()">
                <span class="input-group-text">%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 4. Items Table -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-box-seam"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Items)
          </h5>
          <button type="button" class="btn btn-sm btn-light" onclick="addItemRow()">
            <i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß (Add Row)
          </button>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered mb-0" id="itemsTable" style="font-size: 0.9rem">
              <thead class="table-grey text-center">
                <tr>
                  <th style="width: 200px">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)</th>
                  <th style="width: 80px">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>

                  <!-- Import Columns -->
                  <th class="import-col" style="width: 100px">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (¬•)</th>
                  <th class="import-col" style="width: 100px">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° (¬•)</th>
                  <th class="import-col" style="width: 100px">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° (‡∏ø)</th>

                  <!-- Domestic Columns -->
                  <th class="domestic-col" style="width: 100px">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                  <th class="domestic-col" style="width: 100px">‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                  <th class="domestic-col" style="width: 100px">‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°</th>
                  <th class="domestic-col" style="width: 100px">‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>

                  <th style="width: 50px">üóëÔ∏è</th>
                </tr>
              </thead>
              <tbody id="itemsBody">
                <!-- JS will populate rows here -->
              </tbody>
              <tfoot class="table-grey text-center fw-bold">
                <tr>
                  <td class="text-end">‡∏£‡∏ß‡∏°:</td>
                  <td><span id="sumQty">0</span></td>

                  <td class="import-col"></td>
                  <td class="import-col"><span id="sumYuan">0.00</span></td>
                  <td class="import-col"><span id="sumBaht">0.00</span></td>

                  <td class="domestic-col"></td>
                  <td class="domestic-col"><span id="sumSubtotal">0.00</span></td>
                  <td class="domestic-col"><span id="sumVat">0.00</span></td>
                  <td class="domestic-col"><span id="sumTotal">0.00</span></td>

                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div class="d-flex justify-content-end gap-2 mb-5">
        <a href="{% url 'po_list' %}" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (Cancel)</a>
        <button type="submit" class="btn btn-success btn-lg">
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏• (Create PO)
        </button>
      </div>

      <!-- Hidden inputs needed for form logic -->
      <input type="hidden" name="total_items" id="total_items" value="0" />
    </form>
  </div>
</div>

<!-- Template for SKU Options (Hidden) -->
<datalist id="skuList">
  {% for item in master_items %}
  <option value="{{ item.product_code }}">{{ item.name }}</option>
  {% endfor %}
</datalist>

{% endblock %} {% block extra_js %}
<script>
  let rowCount = 0;

  function addItemRow() {
    rowCount++;
    const tbody = document.getElementById("itemsBody");
    const tr = document.createElement("tr");
    tr.id = `row-${rowCount}`;

    // We render ALL columns (both Import and Domestic) and rely on CSS hiding
    // This simplifies the JS and avoids innerHTML string building complexity with conditionals
    tr.innerHTML = `
            <td>
                <input list="skuList" name="sku_${rowCount}" class="form-control form-control-sm" required placeholder="Type SKU...">
            </td>
            <td>
                <input type="number" name="qty_${rowCount}" class="form-control form-control-sm text-center" min="1" value="1" oninput="recalcAll()">
            </td>
            
            <!-- Import Cols -->
            <td class="import-col">
                 <input type="text" id="view_unit_yuan_${rowCount}" class="form-control form-control-sm text-end border-0 bg-transparent" readonly value="0.00">
            </td>
             <td class="import-col">
                 <input type="text" id="view_total_yuan_${rowCount}" class="form-control form-control-sm text-end border-0 bg-transparent" readonly value="0.00">
            </td>
             <td class="import-col">
                 <input type="text" id="view_total_baht_${rowCount}" class="form-control form-control-sm text-end border-0 bg-transparent" readonly value="0.00">
            </td>

            <!-- Domestic Cols -->
             <td class="domestic-col">
                 <input type="number" step="0.01" name="unit_price_${rowCount}" class="form-control form-control-sm text-end" value="0.00" oninput="recalcAll()">
            </td>
             <td class="domestic-col">
                 <input type="text" id="view_subtotal_${rowCount}" class="form-control form-control-sm text-end border-0 bg-transparent" readonly value="0.00">
            </td>
             <td class="domestic-col">
                 <input type="text" id="view_vat_${rowCount}" class="form-control form-control-sm text-end border-0 bg-transparent" readonly value="0.00">
            </td>
             <td class="domestic-col">
                 <input type="text" id="view_total_${rowCount}" class="form-control form-control-sm text-end border-0 bg-transparent" readonly value="0.00">
            </td>

            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger border-0" onclick="removeRow(${rowCount})">√ó</button>
            </td>
        `;
    tbody.appendChild(tr);
    document.getElementById("total_items").value = rowCount;
    toggleImportFields(); // Ensure visibility of new row columns matches current mode
    recalcAll();
  }

  function removeRow(id) {
    const row = document.getElementById(`row-${id}`);
    if (row) row.remove();
    recalcAll();
  }

  function toggleImportFields() {
    const type = document.getElementById("order_type").value;
    const isImport = (type === 'IMPORTED');

    // 1. Classes to Show/Hide
    const importFields = document.querySelectorAll('.import-field, .import-col');
    const domesticFields = document.querySelectorAll('.domestic-field, .domestic-col');

    // Show/Hide Imports
    importFields.forEach(el => el.style.display = isImport ? '' : 'none');

    // Show/Hide Domestic
    domesticFields.forEach(el => el.style.display = isImport ? 'none' : '');

    // Financial Section Hiding
    // Import Specifics: Exchange Rate, Total Yuan, Shipping Rate
    const exchRate = document.getElementById('exchange_rate');
    const totalYuan = document.getElementById('total_yuan');
    const shipRate = document.querySelector('input[name="shipping_rate_thb_cbm"]');

    if (!isImport) {
      // Domestic: Hide these
      if (exchRate) exchRate.closest('.col-md-4').style.display = 'none';
      if (totalYuan) totalYuan.closest('.col-md-4').style.display = 'none';
      if (shipRate) shipRate.closest('.col-md-4').style.display = 'none';

      const dateLabel = document.getElementById('date_label_ref');
      if (dateLabel) dateLabel.innerText = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
    } else {
      // Import: Show
      if (exchRate) exchRate.closest('.col-md-4').style.display = '';
      if (totalYuan) totalYuan.closest('.col-md-4').style.display = '';
      if (shipRate) shipRate.closest('.col-md-4').style.display = '';

      const dateLabel = document.getElementById('date_label_ref');
      if (dateLabel) dateLabel.innerText = "‡∏ß‡∏±‡∏ô‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (Est. Date)";
    }

    recalcAll();
  }

  function calcEstimatedDate() {
    const orderDate = new Date(document.getElementById("order_date").value);
    const shipTypeEl = document.getElementById("shipping_type");
    const type = document.getElementById("order_type").value;

    if (type !== 'IMPORTED' || !shipTypeEl) return;

    const shipType = shipTypeEl.value;
    let days = 0;
    if (shipType === "CAR") days = 14;
    if (shipType === "SHIP") days = 25;

    if (days > 0 && !isNaN(orderDate.getTime())) {
      orderDate.setDate(orderDate.getDate() + days);
      const destDate = document.getElementById("estimated_date");
      if (destDate) destDate.valueAsDate = orderDate;
    }
  }

  const orderDateEl = document.getElementById("order_date");
  if (orderDateEl) orderDateEl.addEventListener("change", calcEstimatedDate);

  function recalcAll() {
    const type = document.getElementById("order_type").value;
    const isImport = (type === 'IMPORTED');

    // Common: Sum Qty
    let sumQty = 0;
    const qtyInputs = document.querySelectorAll('input[name^="qty_"]');
    qtyInputs.forEach(inp => {
      sumQty += parseFloat(inp.value) || 0;
    });
    const sumQtyEl = document.getElementById("sumQty");
    if (sumQtyEl) sumQtyEl.innerText = sumQty;

    if (isImport) {
      // IMPORT CALCULATION
      const totalYuanEl = document.getElementById("total_yuan");
      const exchRateEl = document.getElementById("exchange_rate");

      const headerTotalYuan = totalYuanEl ? (parseFloat(totalYuanEl.value) || 0) : 0;
      const exchangeRate = exchRateEl ? (parseFloat(exchRateEl.value) || 1.0) : 1.0;

      let checkSumYuan = 0;

      qtyInputs.forEach(inp => {
        const id = inp.name.split('_')[1];
        const qty = parseFloat(inp.value) || 0;

        let lineTotalYuan = 0;
        let unitYuan = 0;

        if (sumQty > 0 && headerTotalYuan > 0) {
          const ratio = qty / sumQty;
          lineTotalYuan = headerTotalYuan * ratio;
          if (qty > 0) unitYuan = lineTotalYuan / qty;
        }
        const lineTotalBaht = lineTotalYuan * exchangeRate;

        const vUnitYuan = document.getElementById(`view_unit_yuan_${id}`);
        const vTotalYuan = document.getElementById(`view_total_yuan_${id}`);
        const vTotalBaht = document.getElementById(`view_total_baht_${id}`);

        if (vUnitYuan) vUnitYuan.value = unitYuan.toFixed(4);
        if (vTotalYuan) vTotalYuan.value = lineTotalYuan.toFixed(2);
        if (vTotalBaht) vTotalBaht.value = lineTotalBaht.toFixed(2);

        checkSumYuan += lineTotalYuan;
      });

      const sumYuanEl = document.getElementById("sumYuan");
      const sumBahtEl = document.getElementById("sumBaht");
      if (sumYuanEl) sumYuanEl.innerText = checkSumYuan.toFixed(2);
      if (sumBahtEl) sumBahtEl.innerText = (checkSumYuan * exchangeRate).toFixed(2);

    } else {
      // DOMESTIC CALCULATION
      const vatRateEl = document.getElementById("vat_rate");
      const vatRate = vatRateEl ? (parseFloat(vatRateEl.value) || 0) : 0;

      let sumSubtotal = 0;
      let sumVat = 0;
      let sumTotal = 0;

      qtyInputs.forEach(inp => {
        const id = inp.name.split('_')[1];
        const qty = parseFloat(inp.value) || 0;

        const unitPriceEl = document.getElementsByName(`unit_price_${id}`)[0];
        const unitPrice = unitPriceEl ? (parseFloat(unitPriceEl.value) || 0) : 0;

        const subtotal = qty * unitPrice;
        const vat = subtotal * (vatRate / 100);
        const total = subtotal + vat;

        const vSubtotal = document.getElementById(`view_subtotal_${id}`);
        const vVat = document.getElementById(`view_vat_${id}`);
        const vTotal = document.getElementById(`view_total_${id}`);

        if (vSubtotal) vSubtotal.value = subtotal.toFixed(2);
        if (vVat) vVat.value = vat.toFixed(2);
        if (vTotal) vTotal.value = total.toFixed(2);

        sumSubtotal += subtotal;
        sumVat += vat;
        sumTotal += total;
      });

      const sumSubEl = document.getElementById("sumSubtotal");
      const sumVatEl = document.getElementById("sumVat");
      const sumTotalEl = document.getElementById("sumTotal");

      if (sumSubEl) sumSubEl.innerText = sumSubtotal.toFixed(2);
      if (sumVatEl) sumVatEl.innerText = sumVat.toFixed(2);
      if (sumTotalEl) sumTotalEl.innerText = sumTotal.toFixed(2);
    }
  }

  // Init
  window.addEventListener('load', () => {
    addItemRow(); // Start with one row
    // toggleImportFields called inside addItemRow but also good to call explicitly if order_type has default
    // toggleImportFields(); 
  });
</script>
{% endblock %}