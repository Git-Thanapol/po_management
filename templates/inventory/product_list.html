{% extends 'base.html' %} {% block title %} ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (ProductManagement)
{%endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12 d-flex justify-content-between align-items-center">
    <h2>üõçÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Product Management)</h2>
    <div class="d-flex gap-2">
      <button
        class="btn btn-warning text-dark fw-bold"
        data-bs-toggle="modal"
        data-bs-target="#importModal"
      >
        <i class="bi bi-cloud-upload"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Import)
      </button>
      <button class="btn btn-primary" onclick="openCreateModal()">
        <i class="bi bi-plus-lg"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Add New)
      </button>
    </div>
  </div>
</div>

<!-- Search -->
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <form method="get" class="row g-2">
      <div class="col-md-7">
        <input
          type="text"
          name="search"
          class="form-control"
          placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
          value="{{ search_query }}"
        />
      </div>
      <div class="col-md-3">
        <select name="category" class="form-select">
          <option value="" {% if not selected_category %}selected{% endif %}>
            ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </option>
          {% for cat in categories %} {% if cat %}
          <option
            value="{{ cat }}"
            {%
            if
            cat=""
            ="selected_category"
            %}selected{%
            endif
            %}
          >
            {{ cat }}
          </option>
          {% endif %} {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-secondary w-100">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
    </form>
  </div>
</div>

<!-- Product Table -->
<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th style="width: 80px">Img</th>
            <th>SKU</th>
            <th>Name</th>
            <th>Links</th>
            <th>Min Limit</th>
            <th>Price (¬•)</th>
            <th>Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for p in products %}
          <tr>
            <td>
              {% if p.image %}
              <img
                src="{{ p.image.url }}"
                class="rounded shadow-sm"
                style="width: 50px; height: 50px; object-fit: cover"
              />
              {% else %}
              <span class="text-muted small">-</span>
              {% endif %}
            </td>
            <td class="fw-bold">{{ p.product_code }}</td>
            <td>{{ p.name|truncatechars:40 }}</td>
            <td>
              {% if p.link_shop %}<a
                href="{{ p.link_shop }}"
                target="_blank"
                class="text-decoration-none"
                ><i class="bi bi-shop"></i> Shop</a
              >{% endif %}
            </td>
            <td>
              <span class="badge bg-secondary">{{ p.min_limit }}</span>
            </td>
            <td>{{ p.cost_yuan_cny }}</td>
            <td class="small text-muted">{{ p.updated_at|date:"d/m/Y" }}</td>
            <td>
              <button
                class="btn btn-sm btn-outline-primary"
                onclick="openEditModal('{{ p.pk }}')"
              >
                <i class="bi bi-pencil"></i> Edit
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center py-4 text-muted">
              ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Product Modal (Create/Edit) -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form
      method="post"
      action="{% url 'save_product' %}"
      enctype="multipart/form-data"
      id="productForm"
    >
      {% csrf_token %}
      <input type="hidden" name="mode" id="productMode" value="create" />

      <div class="modal-content bg-dark text-white text-start">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="productModalLabel">
            üì¶ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (New Product)
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label"
                >‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU) <span class="text-danger">*</span></label
              >
              <input
                type="text"
                name="product_code"
                id="field_sku"
                class="form-control bg-secondary text-white border-secondary"
                required
              />
            </div>
            <div class="col-md-6">
              <label class="form-label"
                >‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Name) <span class="text-danger">*</span></label
              >
              <input
                type="text"
                name="name"
                id="field_name"
                class="form-control bg-secondary text-white border-secondary"
                required
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Min Limit</label>
              <input
                type="number"
                name="min_limit"
                id="field_limit"
                class="form-control bg-secondary text-white border-secondary"
                value="0"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (Category)</label>
              <input
                type="text"
                name="category"
                id="field_category"
                class="form-control bg-secondary text-white border-secondary"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Format/Unit</label>
              <input
                type="text"
                name="product_format"
                id="field_format"
                class="form-control bg-secondary text-white border-secondary"
              />
            </div>
            <div class="col-12">
              <label class="form-label">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image)</label>
              <input
                type="file"
                name="image"
                class="form-control bg-secondary text-white border-secondary"
                accept="image/*"
              />
              <div id="img_preview" class="mt-2 text-center d-none">
                <img src="" style="height: 100px" class="rounded" />
              </div>
            </div>
            <div class="col-12">
              <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Note)</label>
              <textarea
                name="note"
                id="field_note"
                class="form-control bg-secondary text-white border-secondary"
                rows="2"
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button type="submit" class="btn btn-primary fw-bold">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Save)
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form
      method="post"
      action="{% url 'import_data' %}"
      enctype="multipart/form-data"
    >
      {% csrf_token %}
      <input type="hidden" name="type" value="master" />
      <input type="hidden" name="next" value="product_list" />
      <!-- Redirect back here -->

      <div class="modal-content bg-dark text-white">
        <div class="modal-header border-secondary">
          <h5 class="modal-title">
            <i class="bi bi-cloud-upload"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Import
            Master)
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)</label>
            <input
              class="form-control bg-secondary text-white border-secondary"
              type="file"
              name="file"
              accept=".xlsx, .xls"
              required
            />
          </div>
          <div class="alert alert-warning text-dark small">
            <i class="bi bi-info-circle"></i> ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
            (Background Process). ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button type="submit" class="btn btn-warning fw-bold text-dark">
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (Start Import)
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Loading Overlay Script -->
<div
  id="loadingOverlay"
  style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  "
>
  <div class="text-center text-white">
    <div
      class="spinner-border text-warning"
      role="status"
      style="width: 4rem; height: 4rem"
    ></div>
    <h4 class="mt-3">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h4>
  </div>
</div>

<script>
  document
    .querySelector("#importModal form")
    .addEventListener("submit", function () {
      const modal = bootstrap.Modal.getInstance(
        document.getElementById("importModal"),
      );
      modal.hide();
      document.getElementById("loadingOverlay").style.display = "flex";
    });

  // CRUD Logic
  function openCreateModal() {
    document.getElementById("productForm").reset();
    document.getElementById("productMode").value = "create";
    document.getElementById("productModalLabel").innerText =
      "üì¶ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (New Product)";

    document.getElementById("field_sku").readOnly = false;
    document.getElementById("img_preview").classList.add("d-none");

    new bootstrap.Modal(document.getElementById("productModal")).show();
  }

  function openEditModal(sku) {
    // Fetch data
    fetch(`/products/get/${sku}/`)
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          alert("Error: " + data.error);
          return;
        }

        document.getElementById("productMode").value = "edit";
        document.getElementById("productModalLabel").innerText =
          "üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Edit Product)";

        document.getElementById("field_sku").value = data.product_code;
        document.getElementById("field_sku").readOnly = true; // Cannot edit PK

        document.getElementById("field_name").value = data.name;
        document.getElementById("field_limit").value = data.min_limit;
        document.getElementById("field_category").value = data.category;
        document.getElementById("field_format").value = data.product_format;
        document.getElementById("field_note").value = data.note;

        if (data.image_url) {
          const preview = document.getElementById("img_preview");
          preview.classList.remove("d-none");
          preview.querySelector("img").src = data.image_url;
        } else {
          document.getElementById("img_preview").classList.add("d-none");
        }

        new bootstrap.Modal(document.getElementById("productModal")).show();
      });
  }
</script>

{% endblock %}
