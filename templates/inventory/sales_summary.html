{% extends 'base.html' %} {% load humanize %} {% block title %}‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
- JST System{% endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12">
    <h2 class="mb-3">üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô / ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>

    <!-- Filter Section -->
    <div class="card p-3 shadow-sm mb-3">
      <h5 class="card-title text-primary">
        <i class="bi bi-funnel"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Filter)
      </h5>
      <form method="get" class="g-3" id="filterForm">
        <!-- Row 1: Dates and Category -->
        <div class="row mb-3">
          <div class="col-md-2">
            <label class="form-label fw-bold">üìÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date Range)</label>
            <div class="input-group">
              <span class="input-group-text">‡∏à‡∏≤‡∏Å</span>
              <input type="date" name="start_date" class="form-control" value="{{ start_date }}"
                onchange="this.form.submit()" />
            </div>
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <div class="input-group">
              <span class="input-group-text">‡∏ñ‡∏∂‡∏á</span>
              <input type="date" name="end_date" class="form-control" value="{{ end_date }}"
                onchange="this.form.submit()" />
            </div>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-bold">üìÇ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
            <select name="category" class="form-select" onchange="this.form.submit()">
              <option value="" {% if not selected_category %}selected{% endif %}>
                -- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --
              </option>
              {% for cat in categories %} {% if cat %}
              <option value="{{ cat }}" {% if cat == "selected_category" %}selected{% endif %}>
                {{ cat }}
              </option>
              {% endif %} {% endfor %}
            </select>
          </div>

          <!-- Status Filter -->
          <div class="col-md-2">
            <label class="form-label fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
            <select name="status" class="form-select form-select" onchange="this.form.submit()">
              <option value="" {% if not status_filter %}selected{% endif %}>-- ‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
              <option value="normal" {% if status_filter == 'normal' %}selected{% endif %}>üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥ (Normal)
              </option>
              <option value="low" {% if status_filter == 'low' %}selected{% endif %}>üü† ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î (Low)</option>
              <option value="empty" {% if status_filter == 'empty' %}selected{% endif %}>üî¥ ‡∏´‡∏°‡∏î (Out)</option>
              <option value="discontinued" {% if status_filter == 'discontinued' %}selected{% endif %}>‚ùå ‡πÄ‡∏•‡∏¥‡∏Å‡∏Ç‡∏≤‡∏¢
                (Discontinued)</option>
            </select>
          </div>

          <!-- Fav Filter -->
          <div class="col-md-2 text-center">
            <label class="form-label fw-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î </label>
            <input type="checkbox" class="btn-check" id="btn-check-fav" name="fav" value="true" 
              {% if show_fav %}checked{% endif %} onchange="this.form.submit()" autocomplete="off">
            <label class="btn btn btn-outline-danger w-100" for="btn-check-fav">
              {% if show_fav %}‚ù§Ô∏è ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î
              {% else %}ü§ç ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î
              {% endif %}
            </label>
          </div>
        </div>


        <!-- Row 2: Mode and Search -->
        <div class="row">
          <!-- Filter Mode -->
          <div class="col-md-4">
            <label class="form-label fw-bold">üéØ ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Filter Mode)</label>
            <div class="card bg-dark border-secondary p-2">
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="filter_mode" id="modeGeneral" value="general" 
                  {% if filter_mode == "general" %}checked{% endif %} onchange="
                    toggleFilterMode();
                    this.form.submit();
                  " />
                <label class="btn btn-outline-info" for="modeGeneral">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Movement)</label>

                <input type="radio" class="btn-check" name="filter_mode" id="modeFocus" value="focus" 
                  {% if filter_mode == "focus" %}checked{% endif %} onchange="
                    toggleFilterMode();
                    this.form.submit();
                  " />
                <label class="btn btn-outline-warning" for="modeFocus">‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Focus Date)</label>
              </div>

              <!-- Mode Content -->
              <div class="mt-2">
                <!-- General: Movement -->
                <div id="generalFilterGroup"
                  style="display: {% if filter_mode  ==  'general' %}block{% else %}none{% endif %};">
                  <select name="movement" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="all" {% if movement_filter == "all" %}selected{% endif %}>
                      ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </option>
                    <option value="active" {% if movement_filter == "active" %}selected{% endif %}>
                      üü¢ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß
                    </option>
                    <option value="inactive" {% if movement_filter == "inactive" %}selected{% endif %}>
                      üî¥ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß
                    </option>
                  </select>


                </div>

                <!-- Focus: Date Picker -->
                <div id="focusFilterGroup"
                  style="display: {% if filter_mode == 'focus' %}block{% else %}none{% endif %};">
                  <div class="input-group input-group-sm">
                    <span class="input-group-text">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</span>
                    <input type="date" name="focus_date" class="form-control" value="{{ focus_date }}"
                      onchange="this.form.submit()" />
                  </div>
                  <div class="form-text small text-muted mt-1">
                    * ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    (‡πÅ‡∏ï‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Search -->
          <div class="col-md-2">
            <label class="form-label fw-bold">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
            <div class="input-group">
              <input type="text" name="search" class="form-control" value="{{ search_query }}"
                placeholder="‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." onchange="this.form.submit()" />
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Main Table -->
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-striped align-middle mb-0">
            <thead class="table-dark text-nowrap">
              <tr>
                <th class="text-center border-start border-end" style="width: 50px">‚ù§Ô∏è</th>
                <th class="text-center border-start border-end" style="width: 60px">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</th>
                <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏£‡∏π‡∏õ</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="text-center border-start border-end">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="text-end border-start border-end">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                <th class="text-end text-warning border-start border-end">‡∏£‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤</th>
                <th class="text-end text-success border-start border-end">‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô</th>
                <th class="text-end text-primary border-start border-end">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ({{ num_days }} ‡∏ß‡∏±‡∏ô)</th>

                <!-- Daily Columns Headers -->
                {% for d_header in date_headers %}
                <th class="text-center small border-start border-end" style="min-width: 50px">
                  {{ d_header }}
                </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for item in products %}
              <tr>
                <!-- 1. Favorites Toggle -->
                <td class="text-center border-start border-end">
                  <i class="bi {% if item.is_favourite %}bi-heart-fill text-danger{% else %}bi-heart text-muted{% endif %} fs-5"
                    style="cursor: pointer;" onclick="toggleFavourite('{{ item.product_code|escapejs }}', this)"></i>
                </td>

                <!-- 2. History -->
                <td class="text-center border-start border-end">
                  <button class="btn btn-sm btn-outline-info border-0"
                    onclick="loadSalesHistory('{{ item.product_code|escapejs }}')">
                    <i class="bi bi-clock-history fs-5"></i>
                  </button>
                </td>

                <!-- 3. Code -->
                <td class="fw-bold text-primary border-start border-end">{{ item.product_code }}</td>

                <!-- 4. Image -->
                <td class="border-start border-end">
                  {% if item.image %}
                  <img src="{{ item.image.url }}" alt="{{ item.product_code }}" class="rounded"
                    style="height: 40px; width: 40px; object-fit: cover" />
                  {% else %}
                  <span class="text-muted small">No Img</span>
                  {% endif %}
                </td>

                <!-- 5. Name -->
                <td class="border-start border-end">
                  <div class="text-truncate" style="max-width: 200px" title="{{ item.name }}">
                    {{ item.name }}
                  </div>
                </td>

                <!-- 6. Status -->
                <td class="text-center border-start border-end">
                  {% if item.display_status_code == 'discontinued' %}
                  <span class="badge bg-secondary rounded-pill">‚ùå ‡πÄ‡∏•‡∏¥‡∏Å‡∏Ç‡∏≤‡∏¢</span>
                  {% elif item.display_status_code == 'empty' %}
                  <span class="badge bg-danger rounded-pill">‡∏´‡∏°‡∏î</span>
                  {% elif item.display_status_code == 'low' %}
                  <span class="badge bg-warning text-dark rounded-pill">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</span>
                  {% else %}
                  <span class="badge bg-success rounded-pill">‡∏õ‡∏Å‡∏ï‡∏¥</span>
                  {% endif %}
                </td>

                <!-- 7. Stock -->
                <td class="text-end text-muted border-start border-end">
                  {{ item.current_stock|intcomma }}
                </td>

                <!-- 8. Incoming -->
                <td class="text-end text-warning border-start border-end">
                  {% if item.incoming_qty > 0 %}
                  +{{ item.incoming_qty|intcomma }}
                  {% else %}
                  -
                  {% endif %}
                </td>

                <!-- 9. Avg Sales -->
                <td class="text-end text-success border-start border-end">
                  {{ item.avg_sales|floatformat:1 }}
                </td>

                <!-- 10. Total Period -->
                <td class="text-end fw-bold text-primary border-start border-end">
                  {{ item.period_qty|intcomma }}
                </td>

                <!-- Daily Sales Data -->
                {% for qty in item.daily_sales %}
                <td class="text-center small border-start border-end {% if qty > 0 %}fw-bold text-primary{% else %}text-muted{% endif %}">
                  {% if qty > 0 %}{{ qty }}{% else %}-{% endif %}
                </td>
                {% endfor %}
              </tr>
              {% empty %}
              <tr>
                <td colspan="{{ date_headers|length|add:7 }}" class="text-center py-4 text-muted">
                  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="table-dark fw-bold">
              <tr>
                <td colspan="9" class="text-end border-start border-end">‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td>
                <td class="text-end text-primary border-start border-end">
                  {{ total_period_sales|floatformat:2|intcomma }} ‡∏ø
                </td>
                <td class="border-start border-end" colspan="{{ date_headers|length }}"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- History Modal -->
<div class="modal fade" id="salesHistoryModal" tabindex="-1" aria-labelledby="salesHistoryModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="salesHistoryModalLabel">
          ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Sales History)
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <!-- Content loaded via AJAX -->
      </div>
    </div>
  </div>
</div>

<script>
  function loadSalesHistory(sku) {
    const modalBody = document.querySelector("#salesHistoryModal .modal-body");
    modalBody.innerHTML =
      '<div class="text-center py-5"><div class="spinner-border text-info" role="status"></div><p class="mt-2 text-muted">Loading Sales History...</p></div>';

    // Set Title
    const modalTitle = document.querySelector("#salesHistoryModalLabel");
    modalTitle.textContent = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢: " + sku;

    // Show Modal
    var myModal = new bootstrap.Modal(
      document.getElementById("salesHistoryModal"),
    );
    myModal.show();

    // Fetch Data (Root Path)
    const url = `/sales/history/${encodeURIComponent(sku)}/`;

    fetch(url)
      .then((response) => {
        if (!response.ok) throw new Error("Network response was not ok");
        return response.text();
      })
      .then((html) => {
        modalBody.innerHTML = html;
      })
      .catch((error) => {
        modalBody.innerHTML =
          '<div class="alert alert-danger m-3">Error loading history: ' +
          error +
          "</div>";
      });
  }

  function toggleFilterMode() {
    const isGeneral = document.getElementById("modeGeneral").checked;
    document.getElementById("generalFilterGroup").style.display = isGeneral
      ? "block"
      : "none";
    document.getElementById("focusFilterGroup").style.display = isGeneral
      ? "none"
      : "block";
  }

  function toggleFavourite(sku, iconElement) {
    // Toggle UI immediately for better UX
    const isFav = iconElement.classList.contains('bi-heart-fill');

    if (isFav) {
      iconElement.classList.remove('bi-heart-fill', 'text-danger');
      iconElement.classList.add('bi-heart', 'text-muted');
    } else {
      iconElement.classList.remove('bi-heart', 'text-muted');
      iconElement.classList.add('bi-heart-fill', 'text-danger');
    }

    // Send AJAX request
    const formData = new FormData();
    formData.append('sku', sku);
    formData.append('field', 'is_favourite');
    formData.append('value', !isFav);
    formData.append('action', 'update_field');

    fetch('/stock/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          // Revert if error
          alert('Error updating favorite: ' + (data.error || 'Unknown error'));
          if (isFav) {
            iconElement.classList.add('bi-heart-fill', 'text-danger');
            iconElement.classList.remove('bi-heart', 'text-muted');
          } else {
            iconElement.classList.add('bi-heart', 'text-muted');
            iconElement.classList.remove('bi-heart-fill', 'text-danger');
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
        // Revert
        if (isFav) {
          iconElement.classList.add('bi-heart-fill', 'text-danger');
          iconElement.classList.remove('bi-heart', 'text-muted');
        } else {
          iconElement.classList.add('bi-heart', 'text-muted');
          iconElement.classList.remove('bi-heart-fill', 'text-danger');
        }
      });
  }
</script>
{% endblock %}