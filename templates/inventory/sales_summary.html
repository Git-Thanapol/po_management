{% extends 'base.html' %} {% load humanize %} {% block title %}‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
- JST System{% endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12">
    <h2 class="mb-3">üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô / ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>

    <!-- Filter Section -->
    <div class="card p-3 shadow-sm mb-3">
      <h5 class="card-title text-primary">
        <i class="bi bi-funnel"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Filter)
      </h5>
      <form method="get" class="row g-3">
        <div class="col-md-2">
          <label class="form-label">‡∏õ‡∏µ (Year)</label>
          <select name="year" class="form-select">
            {% for y in years %}
            <option
              value="{{ y }}"
              {%
              if
              y=""
              ="selected_year"
              %}selected{%
              endif
              %}
            >
              {{ y }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Month)</label>
          <select name="month" class="form-select">
            {% for m_idx, m_name in thai_months %}
            <option
              value="{{ m_idx }}"
              {%
              if
              m_idx=""
              ="selected_month"
              %}selected{%
              endif
              %}
            >
              {{ m_name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <select name="category" class="form-select">
            <option value="" {% if not selected_category %}selected{% endif %}>
              ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </option>
            {% for cat in categories %} {% if cat %}
            <option
              value="{{ cat }}"
              {%
              if
              cat=""
              ="selected_category"
              %}selected{%
              endif
              %}
            >
              {{ cat }}
            </option>
            {% endif %} {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (SKU/Name)</label>
          <input
            type="text"
            name="search"
            class="form-control"
            value="{{ search_query }}"
            placeholder="‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
          />
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
          </button>
        </div>
      </form>
    </div>

    <!-- Main Table -->
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-striped align-middle mb-0">
            <thead class="table-dark text-nowrap">
              <tr>
                <th class="text-center" style="width: 60px">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</th>
                <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏£‡∏π‡∏õ</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="text-end">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ä‡∏¥‡πâ‡∏ô)</th>
                <th class="text-end">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ø)</th>
                <th class="text-end">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
              </tr>
            </thead>
            <tbody>
              {% for item in products %}
              <tr>
                <td class="text-center">
                  <button
                    class="btn btn-sm btn-outline-info border-0"
                    onclick="loadSalesHistory('{{ item.product_code|escapejs }}')"
                  >
                    <i class="bi bi-clock-history fs-5"></i>
                  </button>
                </td>
                <td class="fw-bold text-primary">{{ item.product_code }}</td>
                <td>
                  {% if item.image %}
                  <img
                    src="{{ item.image.url }}"
                    alt="{{ item.product_code }}"
                    class="rounded"
                    style="height: 40px; width: 40px; object-fit: cover"
                  />
                  {% else %}
                  <span class="text-muted small">No Img</span>
                  {% endif %}
                </td>
                <td>{{ item.name|truncatechars:40 }}</td>
                <td class="text-end fw-bold text-success">
                  {{ item.period_qty|intcomma }}
                </td>
                <td class="text-end text-primary fw-bold">
                  {{ item.period_amount|floatformat:2|intcomma }}
                </td>
                <td class="text-end text-muted">
                  {{ item.current_stock|intcomma }}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="text-center py-4 text-muted">
                  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="table-light fw-bold">
              <tr>
                <td colspan="5" class="text-end">‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td>
                <td class="text-end text-primary">
                  {{ total_period_sales|floatformat:2|intcomma }} ‡∏ø
                </td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- History Modal -->
<div
  class="modal fade"
  id="salesHistoryModal"
  tabindex="-1"
  aria-labelledby="salesHistoryModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="salesHistoryModalLabel">
          ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Sales History)
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-0">
        <!-- Content loaded via AJAX -->
      </div>
    </div>
  </div>
</div>

<script>
  function loadSalesHistory(sku) {
    const modalBody = document.querySelector("#salesHistoryModal .modal-body");
    modalBody.innerHTML =
      '<div class="text-center py-5"><div class="spinner-border text-info" role="status"></div><p class="mt-2 text-muted">Loading Sales History...</p></div>';

    // Set Title
    const modalTitle = document.querySelector("#salesHistoryModalLabel");
    modalTitle.textContent = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢: " + sku;

    // Show Modal
    var myModal = new bootstrap.Modal(
      document.getElementById("salesHistoryModal"),
    );
    myModal.show();

    // Fetch Data (Root Path)
    const url = `/sales/history/${encodeURIComponent(sku)}/`;

    fetch(url)
      .then((response) => {
        if (!response.ok) throw new Error("Network response was not ok");
        return response.text();
      })
      .then((html) => {
        modalBody.innerHTML = html;
      })
      .catch((error) => {
        modalBody.innerHTML =
          '<div class="alert alert-danger m-3">Error loading history: ' +
          error +
          "</div>";
      });
  }
</script>
{% endblock %}
