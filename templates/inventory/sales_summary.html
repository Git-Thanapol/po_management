{% extends 'base.html' %} {% load humanize %} {% block title %}‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
- JST System{% endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12">
    <h2 class="mb-3">üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô / ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>

    <!-- Filter Section -->
    <div class="card p-3 shadow-sm mb-3">
      <h5 class="card-title text-primary">
        <i class="bi bi-funnel"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Filter)
      </h5>
      <form method="get" class="g-3" id="filterForm">
        <!-- Row 1: Dates and Category -->
        <div class="row mb-3">
          <div class="col-md-2">
            <label class="form-label fw-bold">üìÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date Range)</label>
            <div class="input-group">
              <span class="input-group-text">‡∏à‡∏≤‡∏Å</span>
              <input
                type="date"
                name="start_date"
                class="form-control"
                value="{{ start_date }}"
                onchange="this.form.submit()"
              />
            </div>
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <div class="input-group">
              <span class="input-group-text">‡∏ñ‡∏∂‡∏á</span>
              <input
                type="date"
                name="end_date"
                class="form-control"
                value="{{ end_date }}"
                onchange="this.form.submit()"
              />
            </div>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-bold">üìÇ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
            <select
              name="category"
              class="form-select"
              onchange="this.form.submit()"
            >
              <option
                value=""
                {%
                if
                not
                selected_category
                %}selected{%
                endif
                %}
              >
                -- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --
              </option>
              {% for cat in categories %} {% if cat %}
              <option
                value="{{ cat }}"
                {%
                if
                cat=""
                ="selected_category"
                %}selected{%
                endif
                %}
              >
                {{ cat }}
              </option>
              {% endif %} {% endfor %}
            </select>
          </div>
        </div>

        <!-- Row 2: Mode and Search -->
        <div class="row">
          <!-- Filter Mode -->
          <div class="col-md-4">
            <label class="form-label fw-bold"
              >üéØ ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Filter Mode)</label
            >
            <div class="card bg-dark border-secondary p-2">
              <div class="btn-group w-100" role="group">
                <input
                  type="radio"
                  class="btn-check"
                  name="filter_mode"
                  id="modeGeneral"
                  value="general"
                  {%
                  if
                  filter_mode=""
                  ="general"
                  %}checked{%
                  endif
                  %}
                  onchange="
                    toggleFilterMode();
                    this.form.submit();
                  "
                />
                <label class="btn btn-outline-info" for="modeGeneral"
                  >‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Movement)</label
                >

                <input
                  type="radio"
                  class="btn-check"
                  name="filter_mode"
                  id="modeFocus"
                  value="focus"
                  {%
                  if
                  filter_mode=""
                  ="focus"
                  %}checked{%
                  endif
                  %}
                  onchange="
                    toggleFilterMode();
                    this.form.submit();
                  "
                />
                <label class="btn btn-outline-warning" for="modeFocus"
                  >‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Focus Date)</label
                >
              </div>

              <!-- Mode Content -->
              <div class="mt-2">
                <!-- General: Movement -->
                <div
                  id="generalFilterGroup"
                  style="display: {% if filter_mode == 'general' %}block{% else %}none{% endif %};"
                >
                  <select
                    name="movement"
                    class="form-select form-select-sm"
                    onchange="this.form.submit()"
                  >
                    <option
                      value="all"
                      {%
                      if
                      movement_filter=""
                      ="all"
                      %}selected{%
                      endif
                      %}
                    >
                      ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </option>
                    <option
                      value="active"
                      {%
                      if
                      movement_filter=""
                      ="active"
                      %}selected{%
                      endif
                      %}
                    >
                      üü¢ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß
                    </option>
                    <option
                      value="inactive"
                      {%
                      if
                      movement_filter=""
                      ="inactive"
                      %}selected{%
                      endif
                      %}
                    >
                      üî¥ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß
                    </option>
                  </select>
                </div>

                <!-- Focus: Date Picker -->
                <div
                  id="focusFilterGroup"
                  style="display: {% if filter_mode == 'focus' %}block{% else %}none{% endif %};"
                >
                  <div class="input-group input-group-sm">
                    <span class="input-group-text">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</span>
                    <input
                      type="date"
                      name="focus_date"
                      class="form-control"
                      value="{{ focus_date }}"
                      onchange="this.form.submit()"
                    />
                  </div>
                  <div class="form-text small text-muted mt-1">
                    * ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    (‡πÅ‡∏ï‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Search -->
          <div class="col-md-2">
            <label class="form-label fw-bold">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
            <div class="input-group">
              <input
                type="text"
                name="search"
                class="form-control"
                value="{{ search_query }}"
                placeholder="‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
                onchange="this.form.submit()"
              />
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Main Table -->
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-striped align-middle mb-0">
            <thead class="table-dark text-nowrap">
              <tr>
                <th class="text-center" style="width: 60px">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</th>
                <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏£‡∏π‡∏õ</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="text-end">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                <th class="text-end">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <!-- Daily Columns Headers -->
                {% for d_header in date_headers %}
                <th class="text-center small" style="min-width: 50px">
                  {{ d_header }}
                </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for item in products %}
              <tr>
                <td class="text-center">
                  <button
                    class="btn btn-sm btn-outline-info border-0"
                    onclick="loadSalesHistory('{{ item.product_code|escapejs }}')"
                  >
                    <i class="bi bi-clock-history fs-5"></i>
                  </button>
                </td>
                <td class="fw-bold text-primary">{{ item.product_code }}</td>
                <td>
                  {% if item.image %}
                  <img
                    src="{{ item.image.url }}"
                    alt="{{ item.product_code }}"
                    class="rounded"
                    style="height: 40px; width: 40px; object-fit: cover"
                  />
                  {% else %}
                  <span class="text-muted small">No Img</span>
                  {% endif %}
                </td>
                <td>
                  <div
                    class="text-truncate"
                    style="max-width: 200px"
                    title="{{ item.name }}"
                  >
                    {{ item.name }}
                  </div>
                </td>
                <td class="text-end text-muted">
                  {{ item.current_stock|intcomma }}
                </td>
                <td class="text-end fw-bold text-success">
                  {{ item.period_qty|intcomma }}
                </td>
                <td class="text-center">
                  {% if item.current_stock <= 0 %}
                  <span class="badge bg-danger rounded-pill">‡∏´‡∏°‡∏î</span>
                  {% elif item.current_stock <= item.min_limit %}
                  <span class="badge bg-warning text-dark rounded-pill"
                    >‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</span
                  >
                  {% else %}
                  <span class="badge bg-success rounded-pill">‡∏õ‡∏Å‡∏ï‡∏¥</span>
                  {% endif %}
                </td>

                <!-- Daily Sales Data -->
                {% for qty in item.daily_sales %}
                <td
                  class="text-center small {% if qty > 0 %}fw-bold text-primary{% else %}text-muted{% endif %}"
                >
                  {{ qty }}
                </td>
                {% endfor %}
              </tr>
              {% empty %}
              <tr>
                <td
                  colspan="{{ date_headers|length|add:7 }}"
                  class="text-center py-4 text-muted"
                >
                  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="table-light fw-bold">
              <tr>
                <td colspan="5" class="text-end">‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td>
                <td class="text-end text-primary">
                  {{ total_period_sales|floatformat:2|intcomma }} ‡∏ø
                </td>
                <td colspan="{{ date_headers|length|add:1 }}"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- History Modal -->
<div
  class="modal fade"
  id="salesHistoryModal"
  tabindex="-1"
  aria-labelledby="salesHistoryModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="salesHistoryModalLabel">
          ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Sales History)
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-0">
        <!-- Content loaded via AJAX -->
      </div>
    </div>
  </div>
</div>

<script>
  function loadSalesHistory(sku) {
    const modalBody = document.querySelector("#salesHistoryModal .modal-body");
    modalBody.innerHTML =
      '<div class="text-center py-5"><div class="spinner-border text-info" role="status"></div><p class="mt-2 text-muted">Loading Sales History...</p></div>';

    // Set Title
    const modalTitle = document.querySelector("#salesHistoryModalLabel");
    modalTitle.textContent = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢: " + sku;

    // Show Modal
    var myModal = new bootstrap.Modal(
      document.getElementById("salesHistoryModal"),
    );
    myModal.show();

    // Fetch Data (Root Path)
    const url = `/sales/history/${encodeURIComponent(sku)}/`;

    fetch(url)
      .then((response) => {
        if (!response.ok) throw new Error("Network response was not ok");
        return response.text();
      })
      .then((html) => {
        modalBody.innerHTML = html;
      })
      .catch((error) => {
        modalBody.innerHTML =
          '<div class="alert alert-danger m-3">Error loading history: ' +
          error +
          "</div>";
      });
  }

  function toggleFilterMode() {
    const isGeneral = document.getElementById("modeGeneral").checked;
    document.getElementById("generalFilterGroup").style.display = isGeneral
      ? "block"
      : "none";
    document.getElementById("focusFilterGroup").style.display = isGeneral
      ? "none"
      : "block";
  }
</script>
{% endblock %}
