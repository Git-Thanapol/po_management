{% extends 'base.html' %} {% load humanize %} {% block title %}Daily Sales
Summary - JST System{% endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12">
    <h2 class="mb-3">üóìÔ∏è ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>

    <!-- Filter Section -->
    <div class="card p-3 shadow-sm mb-3">
      <form method="get" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status)</label>
          <select name="status" class="form-select">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
            <option value="empty" {% if selected_status == "empty" %}selected{% endif %}>üî¥ ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡∏•‡∏µ‡πâ‡∏¢‡∏á</option>
            <option value="low" {% if selected_status == "low" %}selected{% endif %}>‚ö†Ô∏è ‡∏Ç‡∏≠‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</option>
            <option value="ok" {% if selected_status == "ok" %}selected{% endif %}>üü¢ ‡∏°‡∏µ‡∏Ç‡∏≠‡∏á</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <select name="category" class="form-select">
            <option value="" {% if not selected_category %}selected{% endif %}>‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            {% for cat in categories %} {% if cat %}
            <option value="{{ cat }}" {% if cat == selected_category %}selected{% endif %}>{{ cat }}</option>
            {% endif %} {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Search)</label>
          <input type="text" name="search" class="form-control" value="{{ search_query }}"
            placeholder="SKU ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." />
        </div>

        <div class="col-md-3 d-flex align-items-end px-3">
          <div class="d-flex w-100 gap-2">
            <div class="form-check d-flex align-items-center flex-grow-1" style="height: 38px;">
              <input class="form-check-input me-2" type="checkbox" name="fav" value="true" id="favCheck" 
              {% if show_fav %}checked{% endif %}>
              <label class="form-check-label text-warning user-select-none px-3" for="favCheck">
                <i class="bi bi-heart-fill"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î
              </label>
            </div>
            <button type="submit" class="btn btn-primary flex-grow-1">
              <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
            <button type="button" class="btn btn-success flex-grow-1" onclick="triggerManualSave()">
              <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Main Table -->
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-striped align-middle mb-0" style="font-size: 0.9rem;">
            <thead class="table-dark text-nowrap text-center">
              <tr>
                <th style="width: 50px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</th>
                <th style="width: 50px;">Fav</th>
                <th>‡∏£‡∏´‡∏±‡∏™</th>
                <th>‡∏£‡∏π‡∏õ</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th style="width: 80px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th style="width: 80px;">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                <th style="width: 80px;">‡∏£‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤</th>
                <th style="width: 80px;">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥‚ÄºÔ∏è</th>
                <!-- New Notes Columns -->
                <th style="min-width: 150px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ 1</th>
                <th style="min-width: 150px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ 2</th>
              </tr>
            </thead>
            <tbody>
              {% for item in stock_items %}
              <tr>
                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-outline-warning border-0 p-0"
                    onclick="loadHistory('{{ item.sku }}')">
                    <i class="bi bi-clock-history fs-5"></i>
                  </button>
                </td>

                <!-- Favourite Toggle -->
                <td class="text-center">
                  <i class="bi {% if item.is_favourite %}bi-heart-fill text-danger{% else %}bi-heart text-secondary{% endif %} fs-5 cursor-pointer fav-btn"
                    data-sku="{{ item.sku }}" onclick="toggleFav(this)"></i>
                </td>

                <td class="fw-bold text-primary">{{ item.sku }}</td>

                <td class="text-center">
                  {% if item.image_url %}
                  <img src="{{ item.image_url }}" class="rounded"
                    style="height: 35px; width: 35px; object-fit: cover" />
                  {% else %}
                  <span class="text-muted small">-</span>
                  {% endif %}
                </td>

                <td>{{ item.name|truncatechars:30 }}</td>

                <td class="text-center">
                  {% if item.status_code == 'out_of_stock' %}
                  <span class="badge rounded-pill bg-danger">‡∏´‡∏°‡∏î</span>
                  {% elif item.status_code == 'low_stock' %}
                  <span class="badge rounded-pill bg-warning text-dark">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</span>
                  {% else %}
                  <span class="badge rounded-pill bg-success">‡∏õ‡∏Å‡∏ï‡∏¥</span>
                  {% endif %}
                </td>

                <td
                  class="text-center fw-bold {% if item.current_stock <= 0 %}text-danger{% elif item.current_stock <= item.min_limit %}text-warning{% else %}text-white{% endif %}">
                  {{ item.current_stock|intcomma }}
                </td>

                <!-- Pending Qty -->
                <td class="text-center text-info">
                  {{ item.qty_pending|default:"0"|intcomma }}
                </td>

                <!-- Min Limit (Editable) -->
                <td class="text-center">
                  <input type="number" class="form-control form-control-sm text-center mx-auto note-input"
                    style="width: 70px;" data-sku="{{ item.sku }}" data-field="min_limit" value="{{ item.min_limit }}">
                </td>

                <!-- Note 1 -->
                <td>
                  <input type="text"
                    class="form-control form-control-sm bg-transparent text-white border-secondary note-input"
                    data-sku="{{ item.sku }}" data-field="note1" value="{{ item.note1|default:'' }}">
                </td>

                <!-- Note 2 -->
                <td>
                  <input type="text"
                    class="form-control form-control-sm bg-transparent text-white border-secondary note-input"
                    data-sku="{{ item.sku }}" data-field="note2" value="{{ item.note2|default:'' }}">
                </td>

              </tr>
              {% empty %}
              <tr>
                <td colspan="11" class="text-center py-5 text-muted">
                  <i class="bi bi-box-seam fs-1 d-block mb-2"></i>
                  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (No Stock Data)
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <!-- Content loaded via AJAX -->
      </div>
    </div>
  </div>
</div>

<style>
  .cursor-pointer {
    cursor: pointer;
  }

  .fav-btn:hover {
    transform: scale(1.2);
    transition: transform 0.2s;
  }

  .note-input:focus {
    background-color: #2b3035 !important;
    border-color: #0d6efd !important;
    box-shadow: none;
  }
</style>

<script>
  // CSRF Token Helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  function updateField(sku, field, value) {
    const formData = new FormData();
    formData.append('action', 'update_field');
    formData.append('sku', sku);
    formData.append('field', field);
    formData.append('value', value);

    fetch(window.location.href, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          alert("Error updating: " + data.error);
        }
      })
      .catch(error => console.error('Error:', error));
  }

  function toggleFav(element) {
    const sku = element.dataset.sku;
    const isFav = element.classList.contains('bi-heart-fill');
    const newValue = !isFav;

    // Update UI immediately (Optimistic)
    if (newValue) {
      element.classList.replace('bi-heart', 'bi-heart-fill');
      element.classList.replace('text-secondary', 'text-danger');
    } else {
      element.classList.replace('bi-heart-fill', 'bi-heart');
      element.classList.replace('text-danger', 'text-secondary');
    }

    updateField(sku, 'is_favourite', newValue);
  }

  function triggerManualSave() {
    // Force blur on active element to ensure last edit is saved
    if (document.activeElement) {
      document.activeElement.blur();
    }

    // Find the manual save button using onclick attribute since we don't have a unique ID
    const btn = document.querySelector('button[onclick="triggerManualSave()"]');
    if (btn) {
      const originalText = btn.innerHTML;
      const originalClass = btn.className;

      // Show Saved State
      btn.innerHTML = '<i class="bi bi-check-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';
      btn.className = 'btn btn-outline-success flex-grow-1';

      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.className = originalClass;
      }, 2000);
    }
  }

  // Handle Note Blur
  document.querySelectorAll('.note-input').forEach(input => {
    input.addEventListener('blur', function () {
      const sku = this.dataset.sku;
      const field = this.dataset.field;
      const value = this.value;
      updateField(sku, field, value);
    });
  });

  function loadHistory(sku) {
    const modalBody = document.querySelector("#historyModal .modal-body");
    modalBody.innerHTML = '<div class="text-center py-5"><div class="text-primary spinner-border" role="status"></div><p class="mt-2 text-muted">Loading History...</p></div>';
    new bootstrap.Modal(document.getElementById("historyModal")).show();

    fetch(`/stock/history/${encodeURIComponent(sku)}/`)
      .then(res => res.text())
      .then(html => modalBody.innerHTML = html)
      .catch(err => modalBody.innerHTML = '<div class="alert alert-danger m-3">Error: ' + err + '</div>');
  }
</script>
{% endblock %}