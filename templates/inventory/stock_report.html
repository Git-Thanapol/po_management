{% extends 'base.html' %} {% load humanize %} {% block title %}Daily Sales
Summary - JST System{% endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12">
    <h2 class="mb-3">üóìÔ∏è ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>

    <!-- Filter Section -->
    <div class="card p-3 shadow-sm mb-3">
      <form method="get" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status)</label>
          <select name="status" class="form-select">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
            <option
              value="empty"
              {%
              if
              selected_status=""
              ="empty"
              %}selected{%
              endif
              %}
            >
              üî¥ ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡∏•‡∏µ‡πâ‡∏¢‡∏á
            </option>
            <option
              value="low"
              {%
              if
              selected_status=""
              ="low"
              %}selected{%
              endif
              %}
            >
              ‚ö†Ô∏è ‡∏Ç‡∏≠‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î
            </option>
            <option
              value="ok"
              {%
              if
              selected_status=""
              ="ok"
              %}selected{%
              endif
              %}
            >
              üü¢ ‡∏°‡∏µ‡∏Ç‡∏≠‡∏á
            </option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <select name="category" class="form-select">
            <option value="" {% if not selected_category %}selected{% endif %}>
              ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </option>
            {% for cat in categories %} {% if cat %}
            <option
              value="{{ cat }}"
              {%
              if
              cat=""
              ="selected_category"
              %}selected{%
              endif
              %}
            >
              {{ cat }}
            </option>
            {% endif %} {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Search)</label>
          <input
            type="text"
            name="search"
            class="form-control"
            value="{{ search_query }}"
            placeholder="SKU ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
          />
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-grow-1">
              ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
            <button
              type="submit"
              form="bulkUpdateForm"
              class="btn btn-success flex-grow-1"
            >
              <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Main Table -->
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-striped align-middle mb-0">
            <thead class="table-dark text-nowrap">
              <tr>
                <th class="text-center" style="width: 60px">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</th>
                <th>‡∏£‡∏´‡∏±‡∏™</th>
                <th>‡∏£‡∏π‡∏õ</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="text-center">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                <th class="text-center">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</th>
                <th class="text-center">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                <th class="text-center" style="width: 100px">‡∏à‡∏∏‡∏î‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</th>
                <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              </tr>
            </thead>
            <tbody>
              <form
                id="bulkUpdateForm"
                action="{% url 'update_min_limit' 'bulk' %}"
                method="post"
              >
                {% csrf_token %} {% for item in stock_items %}
                <tr>
                  <td class="text-center">
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-warning border-0"
                      onclick="loadHistory('{{ item.sku }}')"
                    >
                      <i class="bi bi-journal-text fs-5"></i>
                    </button>
                  </td>
                  <td class="fw-bold text-primary">{{ item.sku }}</td>
                  <td>
                    {% if item.image_url %}
                    <img
                      src="{{ item.image_url }}"
                      alt="{{ item.sku }}"
                      class="rounded"
                      style="height: 40px; width: 40px; object-fit: cover"
                    />
                    {% else %}
                    <span class="text-muted small">No Image</span>
                    {% endif %}
                  </td>
                  <td>{{ item.name|truncatechars:40 }}</td>
                  <td class="text-center fw-bold fs-5">
                    {{ item.qty|intcomma }}
                  </td>
                  <td class="text-center text-info">
                    +{{ item.total_received|intcomma }}
                  </td>
                  <td class="text-center text-success">
                    -{{ item.total_sales|intcomma }}
                  </td>
                  <td class="text-center">
                    <input
                      type="number"
                      name="limit_{{ item.sku }}"
                      class="form-control form-control-sm text-center mx-auto"
                      style="width: 70px"
                      value="{{ item.min_limit }}"
                    />
                  </td>
                  <td class="text-center">
                    {% if "‡πÉ‡∏Å‡∏•‡πâ" in item.status %}
                    <span class="badge rounded-pill bg-warning text-dark"
                      >‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</span
                    >
                    {% elif "‡∏´‡∏°‡∏î" in item.status %}
                    <span class="badge rounded-pill bg-danger">‡∏´‡∏°‡∏î</span>
                    {% else %}
                    <span class="badge rounded-pill bg-success">‡∏õ‡∏Å‡∏ï‡∏¥</span>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="9" class="text-center py-4 text-muted">
                    ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                  </td>
                </tr>
                {% endfor %}
              </form>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- History Modal -->
<div
  class="modal fade"
  id="historyModal"
  tabindex="-1"
  aria-labelledby="historyModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="historyModalLabel">
          ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-0">
        <!-- Content loaded via AJAX -->
      </div>
    </div>
  </div>
</div>

<script>
  function loadHistory(sku) {
    const modalBody = document.querySelector("#historyModal .modal-body");
    modalBody.innerHTML =
      '<div class="text-center py-5"><div class="text-primary spinner-border" role="status"></div><p class="mt-2 text-muted">Loading History...</p></div>';

    // Set Title
    const modalTitle = document.querySelector("#historyModalLabel");
    modalTitle.textContent = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: " + sku;

    // Show Modal
    var myModal = new bootstrap.Modal(document.getElementById("historyModal"));
    myModal.show();

    // Fetch Data (Mounted at root)
    const url = `/stock/history/${encodeURIComponent(sku)}/`;
    fetch(url)
      .then((response) => {
        if (!response.ok) throw new Error("Network response was not ok");
        return response.text();
      })
      .then((html) => {
        modalBody.innerHTML = html;
      })
      .catch((error) => {
        modalBody.innerHTML =
          '<div class="alert alert-danger m-3">Error loading history: ' +
          error +
          "</div>";
      });
  }
</script>
{% endblock %}
