{% extends 'base.html' %} {% load humanize %} {% block title %}PO Management -
JST System{% endblock %} {% block content %}
<!-- Copy Modal -->
<div class="modal fade" id="copyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fs-6" id="copyModalTitle">Copy Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <input type="text" class="form-control mb-2 text-center" id="copyInput" readonly />
        <button class="btn btn-primary btn-sm w-100" onclick="copyToClipboard()">
          <i class="bi bi-clipboard"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
        </button>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-12">
    <h2 class="mb-3">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>

    <!-- Filters -->
    <div class="card p-3 shadow-sm mb-3">
      <h5 class="card-title text-primary">
        <i class="bi bi-search"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      </h5>
      <form method="get" class="row g-3">
        <div class="col-md-2">
          <label class="form-label">‡πÄ‡∏•‡∏Ç PO</label>
          <input type="text" name="po_number" class="form-control" value="{{ po_number_query }}"
            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç PO..." />
        </div>
        <div class="col-md-2">
          <label class="form-label">SKU / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <input type="text" name="search" class="form-control" value="{{ search_query }}" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." />
        </div>
        <div class="col-md-2">
          <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select name="status" class="form-select">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
            <option value="Pending" {% if status_filter == "Pending" %}selected{% endif %}>
              ‡∏£‡∏≠‡∏™‡πà‡∏á (Pending)
            </option>
            <option value="arriving_soon" {% if status_filter == "arriving_soon" %}selected{% endif %}>
              ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á
            </option>
            <option value="waiting_shipment" {% if status_filter == "waiting_shipment" %}selected{% endif %}>
              ‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
            </option>
            <option value="incomplete" {% if status_filter == "incomplete" %}selected{% endif %}>
              ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
            </option>
            <option value="Complete" {% if status_filter == "Complete" %}selected{% endif %}>
              ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
            </option>
            <option value="overdue" {% if status_filter == "overdue" %}selected{% endif %}>
              ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
            </option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <select name="category" class="form-select">
            <option value="" {% if not selected_category %} selected {% endif %}>
              ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </option>
            {% for cat in categories %}
            {% if cat %}
            <option value="{{ cat }}" {% if cat == "selected_category" %} selected {% endif %}>
              {{ cat }}
            </option>
            {% endif %}
            {% endfor %}
          </select>
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>
      </form>
    </div>

    <!-- Actions -->
    <div class="d-flex justify-content-start mb-3 gap-2">
      <a href="{% url 'po_create' %}" class="btn btn-success">
        <i class="bi bi-plus-lg"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á PO ‡πÉ‡∏´‡∏°‡πà (Create PO)
      </a>
    </div>

    <!-- Table -->
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-striped align-middle mb-0" style="font-size: 0.85rem">
            <thead class="text-nowrap text-center text-white">
              <tr>
                <th class="bg-dark">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                <th class="bg-primary">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="bg-dark">‡∏£‡∏π‡∏õ</th>
                <th class="bg-dark">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="bg-dark">‡πÄ‡∏•‡∏Ç PO</th>
                <th class="bg-dark">‡∏Ç‡∏ô‡∏™‡πà‡∏á</th>

                <!-- Dates - Purple -->
                <th style="background-color: #6f42c1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                <th style="background-color: #6f42c1">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</th>
                <th style="background-color: #6f42c1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö</th>
                <th style="background-color: #6f42c1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th style="background-color: #6f42c1">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>

                <!-- Received - Purple/Dark -->
                <th style="background-color: #6f42c1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö</th>
                <th style="background-color: #6f42c1">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</th>

                <!-- Ordered/Cost - Green -->
                <th style="background-color: #198754">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                <th style="background-color: #198754">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô (‡∏ø)</th>

                <th class="bg-dark">‡∏¢‡∏≠‡∏î‡∏´‡∏¢‡∏ß‡∏ô (¬•)</th>
                <th class="bg-dark">‡∏¢‡∏≠‡∏î‡∏ö‡∏≤‡∏ó‡∏£‡∏ß‡∏° (‡∏ø)</th>
                <th class="bg-dark">‡πÄ‡∏£‡∏ó‡πÄ‡∏á‡∏¥‡∏ô</th>
                <th class="bg-dark">‡πÄ‡∏£‡∏ó‡∏Ç‡∏ô‡∏™‡πà‡∏á</th>
                <th class="bg-dark">‡∏Ñ‡∏¥‡∏ß (CBM)</th>
                <th class="bg-dark">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏£‡∏ß‡∏°</th>
                <th class="bg-dark">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (KG)</th>
                <th class="bg-dark">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ä‡∏¥‡πâ‡∏ô (¬•)</th>

                <!-- Platforms -->
                <th style="background-color: #fd7e14">SHOPEE</th>
                <th style="background-color: #0d6efd">LAZADA</th>
                <th class="bg-black">TIKTOK</th>

                <th class="bg-dark">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>

                <!-- Extra Info -->
                <th class="bg-dark">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</th>
                <th class="bg-dark">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="bg-dark">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
              </tr>
            </thead>
            <tbody>
              {% for item in po_items %}
              <tr>
                <!-- 1. Edit -->
                <td class="text-center">
                  <a href="{% url 'po_detail' item.header.id %}"
                    class="btn btn-sm btn-outline-warning border-0 p-0 text-warning" title="Edit">
                    <i class="bi bi-pencil-square"></i>
                  </a>
                </td>

                <!-- 2. SKU -->
                <td class="fw-bold text-primary">
                  {{ item.sku.product_code }}
                </td>

                <!-- 3. Image -->
                <td class="text-center">
                  {% if item.sku.image %}
                  <img src="{{ item.sku.image.url }}" class="rounded"
                    style="height: 35px; width: 35px; object-fit: cover" />
                  {% else %}
                  <span class="text-muted small">-</span>
                  {% endif %}
                </td>

                <!-- 4. Status -->
                <td class="text-center">
                  {% if item.header.status == 'Pending' %}
                  <span class="badge rounded-pill bg-warning text-dark">‡∏£‡∏≠‡∏™‡πà‡∏á</span>
                  {% elif item.header.status == 'Complete' %}
                  <span class="badge rounded-pill bg-success">‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span>
                  {% else %}
                  <span class="badge rounded-pill bg-secondary">{{ item.header.status }}</span>
                  {% endif %}
                </td>

                <!-- 5. PO No -->
                <td>
                  <a href="{% url 'po_detail' item.header.id %}" class="text-info text-decoration-none">
                    {{ item.header.po_number }}
                  </a>
                </td>

                <!-- 6. Shipping Type -->
                <td class="text-center">
                  {{ item.header.get_shipping_type_display|default:"-" }}
                </td>

                <!-- 7. Order Date -->
                <td class="text-nowrap">
                  {{ item.header.order_date|date:"d/m/Y" }}
                </td>

                <!-- 8. Est Date -->
                <td class="text-nowrap">
                  {{ item.header.estimated_date|date:"d/m/Y"|default:"-" }}
                </td>

                <!-- 9. Last Bill Date -->
                <td class="text-nowrap text-center text-secondary p-0 align-top">
                  {% for r in item.receipts.all %}
                  <div class="border-bottom border-start border-end py-1 d-flex align-items-center justify-content-center"
                    style="height: 30px;">
                    {{ r.batch.bill_date|date:"d/m/Y"|default:"-" }}
                  </div>
                  {% empty %}
                  <div class="py-1 d-flex align-items-center justify-content-center" style="height: 30px;">-</div>
                  {% endfor %}
                </td>

                <!-- 10. Last Received Date -->
                <td class="text-nowrap text-center text-secondary p-0 align-top">
                  {% for r in item.receipts.all %}
                  <div class="border-bottom  border-end py-1 d-flex align-items-center justify-content-center"
                    style="height: 30px;">
                    {{ r.received_date|date:"d/m/Y" }}
                  </div>
                  {% empty %}
                  <div class="py-1 d-flex align-items-center justify-content-center" style="height: 30px;">-</div>
                  {% endfor %}
                </td>

                <!-- 11. Duration -->
                <td class="text-center p-0 align-top">
                  {% for r in item.receipts.all %}
                  <div class="border-bottom  border-end py-1 d-flex align-items-center justify-content-center"
                    style="height: 30px;">
                    <span class="text-muted">{{ r.duration_from_order }} ‡∏ß‡∏±‡∏ô</span>
                  </div>
                  {% empty %}
                  <div class="py-1 d-flex align-items-center justify-content-center" style="height: 30px;">-</div>
                  {% endfor %}
                </td>

                <!-- 12. Received Qty Status -->
                <td class="text-center p-0 align-top">
                  {% for r in item.receipts.all %}
                  <div class="border-bottom border-end py-1 d-flex align-items-center justify-content-center"
                    style="height: 30px;">
                    <span class="text-muted">{{ r.received_qty }}</span>
                    
                  </div>
                  {% empty %}
                  <div class="py-1 d-flex align-items-center justify-content-center" style="height: 30px;">0</div>
                  {% endfor %}
                </td>

                <td class="text-center {% if item.total_received_qty >= item.qty_ordered %}text-success{% else %}text-warning{% endif %}" >
                  {{ item.total_received_qty }}
                </td>

                <!-- 13. Ordered Qty -->
                <td class="text-center fw-bold">{{ item.qty_ordered }}</td>

                <!-- 14. Unit Cost THB -->
                <td class="text-end text-primary fw-bold">
                  {{ item.unit_cost_thb|floatformat:2|intcomma }}
                </td>

                <!-- 15. Total Yuan -->
                <td class="text-end">
                  {{ item.price_yuan|floatformat:2|intcomma }}
                </td>

                <!-- 16. Total Baht -->
                <td class="text-end">
                  {{ item.price_baht|floatformat:2|intcomma }}
                </td>

                <!-- 17. Ex Rate -->
                <td class="text-center">
                  {{ item.header.exchange_rate|floatformat:2 }}
                </td>

                <!-- 18. Shipping Rate -->
                <td class="text-center">
                  {{ item.header.shipping_rate_thb_cbm|floatformat:2 }}
                </td>

                <!-- 19. Total CBM -->
                <td class="text-end">
                  {{ item.total_received_cbm|floatformat:4|default:"-" }}
                </td>

                <!-- 20. Total Shipping Cost -->
                <td class="text-end">
                  {{ item.total_shipping_cost|floatformat:2|intcomma }}
                </td>

                <!-- 21. Total Weight -->
                <td class="text-end">
                  {{ item.total_received_weight|floatformat:2|default:"-" }}
                </td>

                <!-- 22. Unit Price Yuan -->
                <td class="text-end">
                  {{ item.unit_price_yuan|floatformat:2 }}
                </td>

                <!-- 23. Ref Prices -->
                <td class="text-end text-warning">
                  {{ item.header.ref_price_shopee|floatformat:2|default:"-" }}
                </td>
                <td class="text-end text-primary">
                  {{ item.header.ref_price_lazada|floatformat:2|default:"-" }}
                </td>
                <td class="text-end text-white fw-bold">
                  {{ item.header.ref_price_tiktok|floatformat:2|default:"-" }}
                </td>

                <!-- 24. Note -->
                <td>
                  <small class="d-block text-truncate" style="max-width: 100px" title="{{ item.header.note }}">
                    {{ item.header.note|default:"-" }}
                  </small>
                </td>

                <!-- Extra: Attachments -->
                <td class="text-center">
                  {% with count=item.header.attachments.count %}
                  {% if count > 0 %}
                  <span class="badge bg-secondary text-white">‡πÑ‡∏ü‡∏•‡πå {{ count }}</span>
                  {% else %}
                  <span class="text-muted small">-</span>
                  {% endif %}
                  {% endwith %}
                </td>

                <!-- Extra: Shop Link -->
                <td class="text-center">
                  {% if item.header.link_shop %}
                  <button class="btn btn-sm btn-outline-info border-0"
                    onclick="showCopyModal('Link ‡∏î‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '{{ item.header.link_shop|escapejs }}')">
                    <i class="bi bi-shop"></i>
                  </button>
                  {% else %} - {% endif %}
                </td>

                <!-- Extra: Contact -->
                <td class="text-center">
                  {% if item.header.wechat_contact %}
                  <button class="btn btn-sm btn-outline-success border-0"
                    onclick="showCopyModal('Contact', '{{ item.header.wechat_contact|escapejs }}')">
                    <i class="bi bi-chat-dots"></i>
                  </button>
                  {% else %} - {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="29" class="text-center py-5 text-muted">
                  <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (No PO Found)
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function showCopyModal(title, text) {
    document.getElementById("copyModalTitle").textContent = title;
    document.getElementById("copyInput").value = text;
    new bootstrap.Modal(document.getElementById("copyModal")).show();
  }

  function copyToClipboard() {
    const copyText = document.getElementById("copyInput");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value);

    // Visual feedback
    const btn = document.querySelector("#copyModal .btn-primary");
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
    btn.classList.replace("btn-primary", "btn-success");

    setTimeout(() => {
      btn.innerHTML = originalHtml;
      btn.classList.replace("btn-success", "btn-primary");
    }, 1500);
  }
</script>
{% endblock %}