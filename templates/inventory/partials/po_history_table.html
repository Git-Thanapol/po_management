{% load humanize %}
<div class="table-responsive">
  <table class="table table-dark table-bordered table-sm text-nowrap align-middle" style="font-size: 0.85rem">
    <thead>
      <tr class="text-center align-middle bg-primary text-white">
        <th>รหัสสินค้า</th>
        <th>รูปสินค้า</th>
        <th>สถานะ</th>
        <th>เลข PO</th>
        <th>ประเภทการนำเข้า</th>
        <th>วันที่สั่งซื้อ</th>
        <th>วันคาดการณ์</th>
        <th>วันที่ได้รับ</th>
        <th>ระยะเวลา</th>
        <th>จำนวนที่ได้รับ</th>
        <th>จำนวนสั่งซื้อ</th>
        <th>ต้นทุน/ชิ้น (฿)</th>
        <th>ยอดเงินหยวน (¥)</th>
        <th>ยอดเงินบาทที่ใช้ (฿)</th>
        <th>เรทเงิน</th>
        <th>เรทค่าขนส่ง</th>
        <th>ขนาด (คิว)</th>
        <th>ค่าส่ง</th>
        <th>น้ำหนัก / KG</th>
        <th>ราคา / ชิ้น (หยวน)</th>
        <th>SHOPEE</th>
        <th>LAZADA</th>
        <th>TIKTOK</th>
        <th>หมายเหตุ</th>
        <th>ร้านค้า</th>
        <th>จัดการ</th>
      </tr>
    </thead>
    <tbody>
      {% for row in history_items %}
      <tr>
        <td class="fw-bold text-center">{{ row.po_item.sku.product_code }}</td>
        <td class="text-center">
          {% if row.po_item.sku.image %}
          <img src="{{ row.po_item.sku.image.url }}" style="height: 30px; width: auto" class="rounded" />
          {% endif %}
        </td>
        <td class="text-center">
          {% if row.po_item.header.status == 'Pending' %}
          <span class="badge bg-warning text-dark">รอจัดส่ง</span>
          {% elif row.po_item.header.status == 'Complete' %}
          <span class="badge bg-success">เรียบร้อย</span>
          {% else %}
          <span class="badge bg-secondary">{{ row.po_item.header.status }}</span>
          {% endif %}
        </td>
        <td class="text-center">{{ row.po_item.header.po_number }}</td>
        <td class="text-center">
          {{ row.po_item.header.get_order_type_display }}
        </td>
        <td class="text-center">
          {{ row.po_item.header.order_date|date:"d/m/Y" }}
        </td>
        <td class="text-center">
          {{ row.po_item.header.estimated_date|date:"d/m/Y"|default:"-" }}
        </td>
        <td class="text-center">
          {{ row.received_date|date:"d/m/Y"|default:"-" }}
        </td>
        <td class="text-center">
          {% if row.duration_from_order %}
          {{ row.duration_from_order }} วัน
          {% else %}
          -
          {% endif %}
        </td>
        <td class="text-end text-success fw-bold">
          {{ row.received_qty|intcomma }}
        </td>
        <td class="text-end">{{ row.po_item.qty_ordered|intcomma }}</td>
        <td class="text-end">{{ row.cost_per_piece|floatformat:2 }}</td>
        <td class="text-end">{{ row.total_yuan|floatformat:2 }}</td>
        <td class="text-end">{{ row.po_item.price_baht|floatformat:2 }}</td>
        <td class="text-end">
          {{ row.po_item.header.exchange_rate|floatformat:2 }}
        </td>
        <td class="text-end">{{ row.po_item.header.shipping_rate_thb_cbm|floatformat:2 }}</td>

        <td class="text-end">{{ row.received_cbm|floatformat:4|default:"-" }}</td>

        <!-- Shipping Cost (Calculated or Approx) -->
        <td class="text-end">
          {% widthratio row.received_cbm 1 row.po_item.header.shipping_rate_thb_cbm %}
        </td>

        <td class="text-end">
          {{ row.received_weight|floatformat:2|default:"-" }}
        </td>
        <td class="text-end">{{ row.po_item.price_yuan|floatformat:2 }}</td>

        <!-- Platform Prices -->
        <td class="text-end">
          {{ row.po_item.header.ref_price_shopee|floatformat:2|default:"-" }}
        </td>
        <td class="text-end">
          {{ row.po_item.header.ref_price_lazada|floatformat:2|default:"-" }}
        </td>
        <td class="text-end">
          {{ row.po_item.header.ref_price_tiktok|floatformat:2|default:"-" }}
        </td>

        <td>{{ row.po_item.header.note|default:"-" }}</td>
        <td>
          {% if row.po_item.header.link_shop %}
          <a href="{{ row.po_item.header.link_shop }}" target="_blank" class="text-info"><i
              class="bi bi-link-45deg"></i>
            Link</a>
          {% else %} - {% endif %}
        </td>
        <td class="text-center">
          <form action="{% url 'delete_received_item' row.id %}" method="post" onsubmit="
              return confirm(
                'ยืนยันลบประวัติการรับสินค้านี้? ข้อมูลจำนวนคงเหลือจะถูกคำนวณใหม่',
              );
            ">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger px-2 py-0">
              <i class="bi bi-trash"></i>
            </button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="25" class="text-center py-3 text-muted">
          ไม่พบประวัติการสั่งซื้อ
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>